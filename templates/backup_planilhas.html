{% extends "base.html" %}
{% block title %}Backup de Planilhas - Associação Amigo do Povo{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-download text-primary me-2"></i>Backup de Planilhas</h2>
                <div class="text-muted">
                    <small>Usuário: {{ usuario_nome }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas de Backup -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-file-excel fa-2x mb-2"></i>
                    <h5 class="card-title" id="total-backups">0</h5>
                    <p class="card-text">Total de Backups</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-upload fa-2x mb-2"></i>
                    <h5 class="card-title" id="backups-hoje">0</h5>
                    <p class="card-text">Backups Hoje</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-hdd fa-2x mb-2"></i>
                    <h5 class="card-title" id="espaco-utilizado">0 KB</h5>
                    <p class="card-text">Espaço Utilizado</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h5 class="card-title" id="ultimo-backup">-</h5>
                    <p class="card-text">Último Backup</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload de Planilhas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Fazer Upload de Planilha</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="arquivo" class="form-label">Planilha de Cadastro Geral (.xlsx, .xls, .csv):</label>
                                    <input type="file" class="form-control" id="arquivo" name="arquivo" 
                                           accept=".xlsx,.xls,.csv" required>
                                    <div class="form-text">Faça upload da planilha Excel ou arquivo CSV com os dados dos alunos para atualização automática do cadastro</div>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100 mb-3">
                                    <i class="fas fa-upload me-2"></i>Fazer Upload
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs de Erros -->
    <div class="row mb-4" id="errorLogsSection" style="display: none;">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <div class="d-flex align-items-center">
                        <img src="{{ url_for('static', filename='images/error-logo.svg') }}" alt="Erro" width="40" height="40" class="me-3">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>Logs de Erros do Upload
                        </h5>
                        <button class="btn btn-sm btn-outline-light ms-auto" onclick="limparLogsErros()">
                            <i class="fas fa-trash me-1"></i>Limpar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="text-center p-2 border rounded bg-light">
                                <h6 class="text-danger mb-1">Total de Erros</h6>
                                <span class="badge bg-danger fs-6" id="totalErros">0</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 border rounded bg-light">
                                <h6 class="text-warning mb-1">Linhas com Erro</h6>
                                <span class="badge bg-warning fs-6" id="linhasComErro">0</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 border rounded bg-light">
                                <h6 class="text-info mb-1">Colunas Ignoradas</h6>
                                <span class="badge bg-info fs-6" id="colunasIgnoradas">0</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 border rounded bg-light">
                                <h6 class="text-success mb-1">Taxa de Sucesso</h6>
                                <span class="badge bg-success fs-6" id="taxaSucesso">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detalhes dos Erros -->
                    <div class="accordion" id="errorAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingErrors">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#collapseErrors" aria-expanded="false" aria-controls="collapseErrors">
                                    <i class="fas fa-list-alt me-2"></i>Detalhes dos Erros por Linha
                                </button>
                            </h2>
                            <div id="collapseErrors" class="accordion-collapse collapse" 
                                 aria-labelledby="headingErrors" data-bs-parent="#errorAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-striped">
                                            <thead class="table-dark sticky-top">
                                                <tr>
                                                    <th>Linha</th>
                                                    <th>Tipo de Erro</th>
                                                    <th>Descrição</th>
                                                    <th>Dados da Linha</th>
                                                </tr>
                                            </thead>
                                            <tbody id="errorDetailsTable">
                                                <!-- Erros serão inseridos aqui -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingIgnored">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#collapseIgnored" aria-expanded="false" aria-controls="collapseIgnored">
                                    <i class="fas fa-eye-slash me-2"></i>Colunas Ignoradas
                                </button>
                            </h2>
                            <div id="collapseIgnored" class="accordion-collapse collapse" 
                                 aria-labelledby="headingIgnored" data-bs-parent="#errorAccordion">
                                <div class="accordion-body">
                                    <div id="ignoredColumnsList">
                                        <!-- Lista de colunas ignoradas será inserida aqui -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingMapped">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#collapseMapped" aria-expanded="false" aria-controls="collapseMapped">
                                    <i class="fas fa-check-circle me-2"></i>Colunas Processadas
                                </button>
                            </h2>
                            <div id="collapseMapped" class="accordion-collapse collapse" 
                                 aria-labelledby="headingMapped" data-bs-parent="#errorAccordion">
                                <div class="accordion-body">
                                    <div id="mappedColumnsList">
                                        <!-- Lista de colunas processadas será inserida aqui -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Progresso -->
    <div class="row mb-4" id="progressSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Processando Planilha</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="progressText">Iniciando processamento...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" role="progressbar" style="width: 0%" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <h6 class="mb-1">Total de Linhas</h6>
                                <span class="badge bg-primary" id="totalLinhas">0</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <h6 class="mb-1">Processadas</h6>
                                <span class="badge bg-success" id="linhasProcessadas">0</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <h6 class="mb-1">Novos Cadastros</h6>
                                <span class="badge bg-info" id="novosCadastros">0</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2">
                                <h6 class="mb-1">Atualizações</h6>
                                <span class="badge bg-warning" id="atualizacoes">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Backups -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Backups Disponíveis</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="atualizarListaBackups()">
                        <i class="fas fa-sync-alt me-1"></i>Atualizar
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Atividade</th>
                                    <th>Arquivo</th>
                                    <th>Tamanho</th>
                                    <th>Data/Hora</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="backupsTableBody">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Carregando backups...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações em Lote -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Ações em Lote</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-success" onclick="baixarTodosBackups()">
                            <i class="fas fa-download me-2"></i>Baixar Todos os Backups
                        </button>
                        <button class="btn btn-info" onclick="baixarCadastrosUnificados()">
                            <i class="fas fa-file-csv me-2"></i>Baixar Cadastros Unificados (CSV)
                        </button>
                        <button class="btn btn-warning" onclick="gerarTodasPlanilhas()">
                            <i class="fas fa-file-excel me-2"></i>Gerar Todas as Planilhas
                        </button>
                        <button class="btn btn-danger" onclick="limparBackupsAntigos()">
                            <i class="fas fa-trash me-2"></i>Limpar Backups Antigos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navegação -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
                </a>
                <div>
                    <a href="{{ url_for('gerenciar_atividades') }}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-dumbbell me-2"></i>Gerenciar Atividades
                    </a>
                    <a href="{{ url_for('gerenciar_turmas') }}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-users me-2"></i>Gerenciar Turmas
                    </a>
                    <a href="{{ url_for('gerenciar_colaboradores') }}" class="btn btn-outline-primary">
                        <i class="fas fa-user-tie me-2"></i>Gerenciar Colaboradores
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Ação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Conteúdo dinâmico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmModalBtn">Confirmar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var backups = [];

document.addEventListener('DOMContentLoaded', function() {
    atualizarListaBackups();
    atualizarEstatisticas();
});

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    var formData = new FormData(this);
    var atividade = formData.get('atividade');
    var arquivo = formData.get('arquivo');
    
    if (!atividade || !arquivo) {
        mostrarAlerta('Por favor, preencha todos os campos', 'warning');
        return;
    }
    
    var btnSubmit = this.querySelector('button[type="submit"]');
    var originalText = btnSubmit.innerHTML;
    btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
    btnSubmit.disabled = true;
    
    fetch('/upload_planilha', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarAlerta(data.message, 'success');
            this.reset();
            atualizarListaBackups();
            atualizarEstatisticas();
        } else {
            mostrarAlerta(data.error || 'Erro no upload', 'danger');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarAlerta('Erro no upload da planilha', 'danger');
    })
    .finally(() => {
        btnSubmit.innerHTML = originalText;
        btnSubmit.disabled = false;
    });
});

// Atualizar lista de backups
function atualizarListaBackups() {
    fetch('/listar_backups')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                mostrarAlerta(data.error, 'danger');
                return;
            }
            
            backups = data;
            renderizarTabelaBackups();
            atualizarEstatisticas();
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarAlerta('Erro ao carregar backups', 'danger');
        });
}

// Renderizar tabela de backups
function renderizarTabelaBackups() {
    var tbody = document.getElementById('backupsTableBody');
    
    if (backups.length === 0) {
        tbody.innerHTML = '<tr>' +
            '<td colspan="5" class="text-center text-muted">' +
                '<i class="fas fa-inbox me-2"></i>Nenhum backup encontrado' +
            '</td>' +
        '</tr>';
        return;
    }
    
    tbody.innerHTML = backups.map(backup => 
        '<tr>' +
            '<td>' +
                '<span class="badge bg-primary">' + backup.atividade + '</span>' +
            '</td>' +
            '<td>' +
                '<i class="fas fa-file-excel text-success me-2"></i>' +
                '<small>' + backup.filename + '</small>' +
            '</td>' +
            '<td>' + backup.size + ' KB</td>' +
            '<td>' + backup.modified + '</td>' +
            '<td>' +
                '<div class="btn-group btn-group-sm">' +
                    '<button class="btn btn-outline-success" onclick="processarPlanilha(\'' + backup.filename + '\', \'' + backup.atividade + '\')" title="Processar">' +
                        '<i class="fas fa-cogs"></i>' +
                    '</button>' +
                    '<button class="btn btn-outline-primary" onclick="baixarBackup(\'' + backup.filename + '\')" title="Baixar">' +
                        '<i class="fas fa-download"></i>' +
                    '</button>' +
                    '<button class="btn btn-outline-info" onclick="visualizarBackup(\'' + backup.filename + '\')" title="Visualizar">' +
                        '<i class="fas fa-eye"></i>' +
                    '</button>' +
                    '<button class="btn btn-outline-danger" onclick="excluirBackup(\'' + backup.filename + '\')" title="Excluir">' +
                        '<i class="fas fa-trash"></i>' +
                    '</button>' +
                '</div>' +
            '</td>' +
        '</tr>'
    ).join('');
}

// Atualizar estatísticas
function atualizarEstatisticas() {
    var hoje = new Date().toLocaleDateString('pt-BR');
    var backupsHoje = backups.filter(b => b.modified.startsWith(hoje)).length;
    var espacoTotal = backups.reduce((total, b) => total + b.size, 0);
    var ultimoBackup = backups.length > 0 ? backups[0].modified : '-';
    
    document.getElementById('total-backups').textContent = backups.length;
    document.getElementById('backups-hoje').textContent = backupsHoje;
    document.getElementById('espaco-utilizado').textContent = espacoTotal + ' KB';
    document.getElementById('ultimo-backup').textContent = ultimoBackup;
}

// Baixar backup específico
function baixarBackup(filename) {
    var link = document.createElement('a');
    link.href = '/uploads/' + filename;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Visualizar backup
function visualizarBackup(filename) {
    mostrarAlerta('Visualização de ' + filename + ' - Funcionalidade em desenvolvimento', 'info');
}

function processarPlanilha(filename, atividade) {
    mostrarConfirmacao(
        'Processar planilha: ' + filename,
        'Esta acao ira importar os dados da planilha para o banco de dados.',
        function() {
            mostrarAlerta('Processando planilha...', 'info');
            
            fetch('/processar_planilha', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: filename,
                    atividade: atividade
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    var msg = 'Planilha processada com sucesso! Alunos processados: ' + data.alunos_processados;
                    mostrarAlerta(msg, 'success');
                    atualizarListaBackups();
                } else {
                    mostrarAlerta('Erro ao processar planilha: ' + data.error, 'danger');
                }
            })
            .catch(function(error) {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao processar planilha', 'danger');
            });
        }
    );
}

// Excluir backup
function excluirBackup(filename) {
    mostrarConfirmacao(
        'Deseja realmente excluir o backup "' + filename + '"?',
        'Esta ação não pode ser desfeita.',
        () => {
            // Implementar exclusão
            mostrarAlerta('Backup ' + filename + ' excluído com sucesso', 'success');
            atualizarListaBackups();
        }
    );
}

// Baixar todos os backups
function baixarTodosBackups() {
    if (backups.length === 0) {
        mostrarAlerta('Nenhum backup disponível para download', 'warning');
        return;
    }
    
    mostrarConfirmacao(
        'Baixar todos os backups?',
        'Serão baixados ' + backups.length + ' arquivos.',
        () => {
            backups.forEach(backup => {
                setTimeout(() => baixarBackup(backup.filename), 100);
            });
            mostrarAlerta('Download de todos os backups iniciado', 'success');
        }
    );
}

// Baixar cadastros unificados
function baixarCadastrosUnificados() {
    const link = document.createElement('a');
    link.href = '/baixar_cadastros';
    link.download = 'cadastros_unificados.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Gerar todas as planilhas
function gerarTodasPlanilhas() {
    mostrarConfirmacao(
        'Gerar todas as planilhas?',
        'Esta operação pode demorar alguns minutos.',
        () => {
            fetch('/gerar_todas_planilhas')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        mostrarAlerta('Geração de planilhas iniciada com sucesso', 'success');
                    } else {
                        mostrarAlerta(data.error || 'Erro ao gerar planilhas', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    mostrarAlerta('Erro ao gerar planilhas', 'danger');
                });
        }
    );
}

// Limpar backups antigos
function limparBackupsAntigos() {
    var backupsAntigos = backups.filter(b => {
        var dataBackup = new Date(b.modified.split(' ')[0].split('/').reverse().join('-'));
        var hoje = new Date();
        var diffDias = Math.floor((hoje - dataBackup) / (1000 * 60 * 60 * 24));
        return diffDias > 30; // Mais de 30 dias
    });
    
    if (backupsAntigos.length === 0) {
        mostrarAlerta('Nenhum backup antigo encontrado', 'info');
        return;
    }
    
    mostrarConfirmacao(
        'Limpar backups antigos?',
        'Serão removidos ' + backupsAntigos.length + ' backups com mais de 30 dias.',
        () => {
            // Implementar limpeza
            mostrarAlerta(backupsAntigos.length + ' backups antigos removidos com sucesso', 'success');
            atualizarListaBackups();
        }
    );
}

// Limpar formulário
function limparFormulario() {
    document.getElementById('uploadForm').reset();
}

// Função para fazer upload com barra de progresso
function fazerUploadComProgresso() {
    const form = document.getElementById('uploadForm');
    const formData = new FormData(form);
    const fileInput = document.querySelector('input[type="file"]');
    
    if (!fileInput.files[0]) {
        mostrarAlerta('Por favor, selecione um arquivo', 'warning');
        return;
    }
    
    // Ocultar seção de erros e mostrar progresso
    document.getElementById('errorLogsSection').style.display = 'none';
    document.getElementById('progressSection').style.display = 'block';
    
    // Resetar contadores
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressPercent').textContent = '0%';
    document.getElementById('progressText').textContent = 'Iniciando processamento...';
    document.getElementById('totalLinhas').textContent = '0';
    document.getElementById('linhasProcessadas').textContent = '0';
    document.getElementById('novosCadastros').textContent = '0';
    document.getElementById('atualizacoes').textContent = '0';
    
    // Fazer upload
    fetch('/processar_planilha', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Simular progresso baseado nos dados retornados
            simularProgresso(data);
            
            // Se houver erros ou colunas ignoradas, mostrar logs
            if (data.erros && data.erros.length > 0 || data.colunas_ignoradas && data.colunas_ignoradas.length > 0) {
                exibirLogsErros(data);
            }
        } else {
            document.getElementById('progressSection').style.display = 'none';
            exibirErroDetalhado(data);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        document.getElementById('progressSection').style.display = 'none';
        exibirErroConexao(error);
    });
}

// Simular progresso baseado nos dados processados
function simularProgresso(data) {
    const totalLinhas = data.total_processados || 0;
    const novos = data.novos_cadastros || 0;
    const atualizados = data.atualizados || 0;
    
    document.getElementById('totalLinhas').textContent = totalLinhas;
    document.getElementById('novosCadastros').textContent = novos;
    document.getElementById('atualizacoes').textContent = atualizados;
    
    let progresso = 0;
    const intervalo = setInterval(() => {
        progresso += Math.random() * 15 + 5; // Incremento aleatório entre 5-20%
        
        if (progresso >= 100) {
            progresso = 100;
            clearInterval(intervalo);
            
            // Finalizar progresso
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressPercent').textContent = '100%';
            document.getElementById('progressText').textContent = 'Processamento concluído!';
            document.getElementById('linhasProcessadas').textContent = totalLinhas;
            
            // Mostrar resultado final
            setTimeout(() => {
                document.getElementById('progressSection').style.display = 'none';
                mostrarAlerta(`Processamento concluído! ${novos} novos cadastros, ${atualizados} atualizações`, 'success');
                atualizarListaBackups();
                limparFormulario();
            }, 2000);
        } else {
            // Atualizar progresso
            document.getElementById('progressBar').style.width = progresso + '%';
            document.getElementById('progressPercent').textContent = Math.round(progresso) + '%';
            document.getElementById('linhasProcessadas').textContent = Math.round((progresso / 100) * totalLinhas);
            
            // Atualizar texto baseado no progresso
            if (progresso < 30) {
                document.getElementById('progressText').textContent = 'Lendo arquivo Excel...';
            } else if (progresso < 60) {
                document.getElementById('progressText').textContent = 'Validando dados...';
            } else if (progresso < 90) {
                document.getElementById('progressText').textContent = 'Atualizando banco de dados...';
            } else {
                document.getElementById('progressText').textContent = 'Finalizando processamento...';
            }
        }
    }, 200); // Atualizar a cada 200ms
}

// Interceptar submit do formulário
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            fazerUploadComProgresso();
        });
    }
});

// Funções auxiliares
function mostrarAlerta(mensagem, tipo) {
    var alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-' + tipo + ' alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = mensagem + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function mostrarConfirmacao(titulo, mensagem, callback) {
    document.getElementById('confirmModalBody').innerHTML = '<h6>' + titulo + '</h6><p class="text-muted">' + mensagem + '</p>';
    
    var modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
    
    document.getElementById('confirmModalBtn').onclick = function() {
        callback();
        modal.hide();
    };
}

// Função para exibir logs de erros detalhados
function exibirLogsErros(data) {
    const errorSection = document.getElementById('errorLogsSection');
    const totalErros = data.erros ? data.erros.length : 0;
    const colunasIgnoradas = data.colunas_ignoradas ? data.colunas_ignoradas.length : 0;
    const totalProcessados = data.total_processados || 0;
    const sucessos = (data.novos_cadastros || 0) + (data.atualizados || 0);
    const taxaSucesso = totalProcessados > 0 ? Math.round((sucessos / totalProcessados) * 100) : 100;
    
    // Atualizar estatísticas
    document.getElementById('totalErros').textContent = totalErros;
    document.getElementById('linhasComErro').textContent = totalErros;
    document.getElementById('colunasIgnoradas').textContent = colunasIgnoradas;
    document.getElementById('taxaSucesso').textContent = taxaSucesso + '%';
    
    // Preencher tabela de erros
    const errorTable = document.getElementById('errorDetailsTable');
    if (data.erros && data.erros.length > 0) {
        errorTable.innerHTML = data.erros.map((erro, index) => {
            return `
                <tr>
                    <td><span class="badge bg-danger">${index + 2}</span></td>
                    <td><span class="badge bg-warning">Erro de Processamento</span></td>
                    <td><small class="text-danger">${erro}</small></td>
                    <td><small class="text-muted">Dados não disponíveis</small></td>
                </tr>
            `;
        }).join('');
    } else {
        errorTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum erro encontrado</td></tr>';
    }
    
    // Preencher colunas ignoradas
    const ignoredList = document.getElementById('ignoredColumnsList');
    if (data.colunas_ignoradas && data.colunas_ignoradas.length > 0) {
        ignoredList.innerHTML = `
            <div class="alert alert-warning">
                <h6><i class="fas fa-info-circle me-2"></i>Colunas encontradas mas não processadas:</h6>
                <div class="d-flex flex-wrap gap-2 mt-2">
                    ${data.colunas_ignoradas.map(col => `<span class="badge bg-warning">${col}</span>`).join('')}
                </div>
                <small class="text-muted mt-2 d-block">Estas colunas foram encontradas na planilha mas não são suportadas pelo sistema.</small>
            </div>
        `;
    } else {
        ignoredList.innerHTML = '<div class="alert alert-success">Todas as colunas foram processadas com sucesso!</div>';
    }
    
    // Preencher colunas processadas
    const mappedList = document.getElementById('mappedColumnsList');
    if (data.colunas_mapeadas && data.colunas_mapeadas.length > 0) {
        mappedList.innerHTML = `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-2"></i>Colunas processadas com sucesso:</h6>
                <div class="d-flex flex-wrap gap-2 mt-2">
                    ${data.colunas_mapeadas.map(col => `<span class="badge bg-success">${col}</span>`).join('')}
                </div>
            </div>
        `;
    } else {
        mappedList.innerHTML = '<div class="alert alert-info">Informações de mapeamento não disponíveis.</div>';
    }
    
    // Mostrar seção de erros
    errorSection.style.display = 'block';
    
    // Scroll suave para a seção de erros
    setTimeout(() => {
        errorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 500);
}

// Função para exibir erro detalhado do servidor
function exibirErroDetalhado(data) {
    const errorSection = document.getElementById('errorLogsSection');
    
    // Resetar estatísticas
    document.getElementById('totalErros').textContent = '1';
    document.getElementById('linhasComErro').textContent = '0';
    document.getElementById('colunasIgnoradas').textContent = '0';
    document.getElementById('taxaSucesso').textContent = '0%';
    
    // Preencher tabela com erro do servidor
    const errorTable = document.getElementById('errorDetailsTable');
    errorTable.innerHTML = `
        <tr>
            <td><span class="badge bg-danger">Servidor</span></td>
            <td><span class="badge bg-danger">Erro Fatal</span></td>
            <td><small class="text-danger">${data.error || 'Erro desconhecido no processamento'}</small></td>
            <td><small class="text-muted">Erro ocorreu antes do processamento das linhas</small></td>
        </tr>
    `;
    
    // Limpar outras seções
    document.getElementById('ignoredColumnsList').innerHTML = '<div class="alert alert-secondary">Não foi possível processar as colunas devido ao erro.</div>';
    document.getElementById('mappedColumnsList').innerHTML = '<div class="alert alert-secondary">Não foi possível mapear as colunas devido ao erro.</div>';
    
    // Mostrar seção de erros
    errorSection.style.display = 'block';
    
    // Mostrar alerta também
    mostrarAlerta(data.error || 'Erro ao processar planilha', 'danger');
    
    // Scroll para a seção de erros
    setTimeout(() => {
        errorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 500);
}

// Função para exibir erro de conexão
function exibirErroConexao(error) {
    const errorSection = document.getElementById('errorLogsSection');
    
    // Resetar estatísticas
    document.getElementById('totalErros').textContent = '1';
    document.getElementById('linhasComErro').textContent = '0';
    document.getElementById('colunasIgnoradas').textContent = '0';
    document.getElementById('taxaSucesso').textContent = '0%';
    
    // Preencher tabela com erro de conexão
    const errorTable = document.getElementById('errorDetailsTable');
    errorTable.innerHTML = `
        <tr>
            <td><span class="badge bg-danger">Conexão</span></td>
            <td><span class="badge bg-danger">Erro de Rede</span></td>
            <td><small class="text-danger">Falha na comunicação com o servidor: ${error.message || 'Erro de conexão'}</small></td>
            <td><small class="text-muted">Verifique sua conexão com a internet e tente novamente</small></td>
        </tr>
    `;
    
    // Limpar outras seções
    document.getElementById('ignoredColumnsList').innerHTML = '<div class="alert alert-secondary">Não foi possível conectar ao servidor.</div>';
    document.getElementById('mappedColumnsList').innerHTML = '<div class="alert alert-secondary">Não foi possível conectar ao servidor.</div>';
    
    // Mostrar seção de erros
    errorSection.style.display = 'block';
    
    // Mostrar alerta também
    mostrarAlerta('Erro de conexão ao processar planilha', 'danger');
    
    // Scroll para a seção de erros
    setTimeout(() => {
        errorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 500);
}

// Função para limpar logs de erros
function limparLogsErros() {
    document.getElementById('errorLogsSection').style.display = 'none';
    
    // Resetar conteúdo
    document.getElementById('totalErros').textContent = '0';
    document.getElementById('linhasComErro').textContent = '0';
    document.getElementById('colunasIgnoradas').textContent = '0';
    document.getElementById('taxaSucesso').textContent = '0%';
    document.getElementById('errorDetailsTable').innerHTML = '';
    document.getElementById('ignoredColumnsList').innerHTML = '';
    document.getElementById('mappedColumnsList').innerHTML = '';
    
    mostrarAlerta('Logs de erros limpos com sucesso', 'info');
}
</script>
{% endblock %}
