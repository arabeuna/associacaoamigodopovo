{% extends "base.html" %}

{% block title %}Backup Planilhas - Associação Amigo do Povo{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 text-center mb-4">
            <i class="fas fa-download text-success"></i>
            Backup de Planilhas de Frequência
        </h1>
        <p class="text-center text-muted">
            Gere, baixe e faça upload de planilhas de frequência por atividade
        </p>
    </div>
</div>

<!-- Mensagens de feedback -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Aviso para admins -->
<div class="alert alert-info" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Área Administrativa:</strong> Apenas administradores podem acessar esta funcionalidade.
</div>

<!-- Download de Cadastros -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Backup de Cadastros Unificados
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    Faça download de todos os cadastros de alunos em formato CSV, equivalente ao arquivo Cadastros_Unificados_GOOGLE_v2.xlsx
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-success btn-lg w-100" onclick="baixarCadastros()">
                            <i class="fas fa-download me-2"></i>
                            Baixar Cadastros Unificados
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-info btn-lg w-100" onclick="baixarTodasPlanilhas()">
                            <i class="fas fa-file-archive me-2"></i>
                            Baixar Todas as Planilhas (ZIP)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gerar Planilhas -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    Gerar Nova Planilha de Frequência
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="atividadeGerar" class="form-label">
                            <i class="fas fa-graduation-cap me-1"></i>
                            Atividade:
                        </label>
                        <select class="form-select" id="atividadeGerar">
                            <option value="">Selecione uma atividade...</option>
                            {% for atividade in atividades %}
                            <option value="{{ atividade }}">{{ atividade }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="mesAno" class="form-label">
                            <i class="fas fa-calendar me-1"></i>
                            Mês/Ano:
                        </label>
                        <input type="month" class="form-control" id="mesAno" value="2024-12">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" onclick="gerarPlanilha()">
                            <i class="fas fa-download me-2"></i>
                            Gerar e Baixar Planilha
                        </button>
                    </div>
                </div>
                
                <!-- Informações sobre as atividades -->
                <div class="mt-4">
                    <h6 class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Atividades Disponíveis:
                    </h6>
                    <div class="row">
                        {% for atividade in atividades %}
                        <div class="col-md-3 mb-2">
                            <span class="badge bg-secondary">
                                <i class="fas fa-users me-1"></i>
                                {{ atividade }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload de Planilhas -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Enviar Planilha Editada
                </h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="atividadeUpload" class="form-label">
                                <i class="fas fa-graduation-cap me-1"></i>
                                Atividade:
                            </label>
                            <select class="form-select" id="atividadeUpload" name="atividade" required>
                                <option value="">Selecione uma atividade...</option>
                                {% for atividade in atividades %}
                                <option value="{{ atividade }}">{{ atividade }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="arquivo" class="form-label">
                                <i class="fas fa-file-excel me-1"></i>
                                Arquivo:
                            </label>
                            <input type="file" class="form-control" id="arquivo" name="arquivo" 
                                   accept=".xlsx,.xls,.csv" required>
                            <div class="form-text">
                                Formatos aceitos: .xlsx, .xls, .csv
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="fas fa-upload me-2"></i>
                                Enviar Planilha
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Instruções -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="text-muted mb-2">
                        <i class="fas fa-lightbulb me-1"></i>
                        Como usar:
                    </h6>
                    <ol class="mb-0 text-muted">
                        <li>Baixe uma planilha modelo usando o botão "Gerar e Baixar Planilha"</li>
                        <li>Edite a planilha no Excel, preenchendo as presenças (P = Presente, F = Falta, etc.)</li>
                        <li>Salve o arquivo e faça upload aqui</li>
                        <li>O sistema processará os dados automaticamente</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Histórico de Backups -->
<div class="row">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Histórico de Backups
                </h5>
            </div>
            <div class="card-body">
                <div id="loadingBackups" class="text-center">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Carregando backups...
                </div>
                
                <div id="tabelaBackups" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fas fa-file me-1"></i> Nome do Arquivo</th>
                                    <th><i class="fas fa-graduation-cap me-1"></i> Atividade</th>
                                    <th><i class="fas fa-weight me-1"></i> Tamanho</th>
                                    <th><i class="fas fa-calendar me-1"></i> Modificado</th>
                                </tr>
                            </thead>
                            <tbody id="backupsList">
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="semBackups" style="display: none;" class="text-center text-muted">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p>Nenhum backup encontrado</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Função para gerar planilha
function gerarPlanilha() {
    const atividade = document.getElementById('atividadeGerar').value;
    const mesAno = document.getElementById('mesAno').value;
    
    if (!atividade) {
        alert('Por favor, selecione uma atividade!');
        return;
    }
    
    // Criar URL para download
    const url = `/gerar_planilha/${encodeURIComponent(atividade)}?mes_ano=${mesAno}`;
    
    // Fazer download
    const link = document.createElement('a');
    link.href = url;
    link.click();
}

// Função para upload
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const btnSubmit = this.querySelector('button[type="submit"]');
    const originalText = btnSubmit.innerHTML;
    
    // Mostrar loading
    btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
    btnSubmit.disabled = true;
    
    fetch('/upload_planilha', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('uploadForm').reset();
            carregarBackups(); // Recarregar lista
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        alert('Erro ao enviar arquivo: ' + error);
    })
    .finally(() => {
        btnSubmit.innerHTML = originalText;
        btnSubmit.disabled = false;
    });
});

// Função para carregar lista de backups
function carregarBackups() {
    fetch('/listar_backups')
    .then(response => response.json())
    .then(data => {
        const loadingDiv = document.getElementById('loadingBackups');
        const tabelaDiv = document.getElementById('tabelaBackups');
        const semBackupsDiv = document.getElementById('semBackups');
        const tbody = document.getElementById('backupsList');
        
        loadingDiv.style.display = 'none';
        
        if (data.length > 0) {
            tbody.innerHTML = '';
            data.forEach(backup => {
                const row = `
                    <tr>
                        <td>
                            <i class="fas fa-file-excel text-success me-2"></i>
                            ${backup.nome}
                        </td>
                        <td>
                            <span class="badge bg-primary">${backup.atividade}</span>
                        </td>
                        <td>${backup.tamanho}</td>
                        <td>
                            <i class="fas fa-clock me-1"></i>
                            ${backup.modificado}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            tabelaDiv.style.display = 'block';
            semBackupsDiv.style.display = 'none';
        } else {
            tabelaDiv.style.display = 'none';
            semBackupsDiv.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Erro ao carregar backups:', error);
        document.getElementById('loadingBackups').innerHTML = 
            '<i class="fas fa-exclamation-triangle text-warning me-2"></i>Erro ao carregar backups';
    });
}

// Função para baixar cadastros unificados
function baixarCadastros() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Gerando...';
    btn.disabled = true;
    
    window.location.href = '/baixar_cadastros';
    
    // Reativar botão após delay
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 3000);
}

// Função para baixar todas as planilhas em ZIP
function baixarTodasPlanilhas() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Compactando...';
    btn.disabled = true;
    
    window.location.href = '/gerar_todas_planilhas';
    
    // Reativar botão após delay
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 5000);
}

// Carregar backups ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    carregarBackups();
});
</script>
{% endblock %}
