{% extends "base.html" %}

{% block title %}Relatórios - Associação Amigo do Povo{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 text-center mb-4">
                <i class="fas fa-chart-bar text-primary"></i>
                Relatórios e Estatísticas
            </h1>
            <p class="text-muted text-center">Visualize relatórios detalhados sobre alunos, atividades e frequência</p>
        </div>
    </div>

    <!-- Filtros de Relatório -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Configurar Relatório
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="mes" class="form-label">Mês</label>
                            <select name="mes" id="mes" class="form-select">
                                <option value="Janeiro" {% if mes_selecionado == 'Janeiro' %}selected{% endif %}>Janeiro</option>
                                <option value="Fevereiro" {% if mes_selecionado == 'Fevereiro' %}selected{% endif %}>Fevereiro</option>
                                <option value="Março" {% if mes_selecionado == 'Março' %}selected{% endif %}>Março</option>
                                <option value="Abril" {% if mes_selecionado == 'Abril' %}selected{% endif %}>Abril</option>
                                <option value="Maio" {% if mes_selecionado == 'Maio' %}selected{% endif %}>Maio</option>
                                <option value="Junho" {% if mes_selecionado == 'Junho' %}selected{% endif %}>Junho</option>
                                <option value="Julho" {% if mes_selecionado == 'Julho' %}selected{% endif %}>Julho</option>
                                <option value="Agosto" {% if mes_selecionado == 'Agosto' %}selected{% endif %}>Agosto</option>
                                <option value="Setembro" {% if mes_selecionado == 'Setembro' %}selected{% endif %}>Setembro</option>
                                <option value="Outubro" {% if mes_selecionado == 'Outubro' %}selected{% endif %}>Outubro</option>
                                <option value="Novembro" {% if mes_selecionado == 'Novembro' %}selected{% endif %}>Novembro</option>
                                <option value="Dezembro" {% if mes_selecionado == 'Dezembro' %}selected{% endif %}>Dezembro</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="atividade" class="form-label">Atividade</label>
                            <select name="atividade" id="atividade" class="form-select">
                                <option value="">Todas as atividades</option>
                                <option value="Futebol">Futebol</option>
                                <option value="Vôlei">Vôlei</option>
                                <option value="Basquete">Basquete</option>
                                <option value="Jiu-Jitsu">Jiu-Jitsu</option>
                                <option value="Capoeira">Capoeira</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="tipo_relatorio" class="form-label">Tipo de Relatório</label>
                            <select name="tipo_relatorio" id="tipo_relatorio" class="form-select">
                                <option value="frequencia">Frequência</option>
                                <option value="atividades">Atividades</option>
                                <option value="alunos">Alunos</option>
                                <option value="turmas">Turmas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>
                                    Gerar Relatório
                                </button>
                                <button type="button" class="btn btn-success ms-2" onclick="exportarRelatorio()">
                                    <i class="fas fa-download me-2"></i>
                                    Exportar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo Estatístico -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-users fa-2x text-primary mb-2"></i>
                    <h4 id="total-alunos">0</h4>
                    <p class="text-muted mb-0">Total de Alunos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-check fa-2x text-success mb-2"></i>
                    <h4 id="total-presencas">0</h4>
                    <p class="text-muted mb-0">Total de Presenças</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-times fa-2x text-danger mb-2"></i>
                    <h4 id="total-faltas">0</h4>
                    <p class="text-muted mb-0">Total de Faltas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                    <h4 id="taxa-geral">0%</h4>
                    <p class="text-muted mb-0">Taxa de Presença</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos e Tabelas -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Distribuição por Atividade
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="graficoAtividades" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Frequência ao Longo do Mês
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="graficoFrequencia" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Dados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        Dados Detalhados
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabelaRelatorio">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nome</th>
                                    <th>Atividade</th>
                                    <th>Turma</th>
                                    <th>Presenças</th>
                                    <th>Faltas</th>
                                    <th>Taxa</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="row">
        <div class="col-12 text-center">
            <button class="btn btn-lg btn-primary" onclick="imprimirRelatorio()">
                <i class="fas fa-print me-2"></i>
                Imprimir Relatório
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-lg btn-secondary ms-3">
                <i class="fas fa-arrow-left me-2"></i>
                Voltar ao Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Dados de exemplo para os gráficos
const dadosAtividades = {
    labels: ['Futebol', 'Vôlei', 'Basquete', 'Jiu-Jitsu', 'Capoeira'],
    datasets: [{
        data: [30, 25, 20, 15, 10],
        backgroundColor: [
            '#FF6384',
            '#36A2EB',
            '#FFCE56',
            '#4BC0C0',
            '#9966FF'
        ]
    }]
};

const dadosFrequencia = {
    labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
    datasets: [{
        label: 'Presenças',
        data: [85, 78, 92, 88],
        borderColor: '#36A2EB',
        backgroundColor: 'rgba(54, 162, 235, 0.1)',
        tension: 0.1
    }]
};

// Inicializar gráficos
let graficoAtividades, graficoFrequencia;

document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de pizza para atividades
    const ctxAtividades = document.getElementById('graficoAtividades').getContext('2d');
    graficoAtividades = new Chart(ctxAtividades, {
        type: 'pie',
        data: dadosAtividades,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Gráfico de linha para frequência
    const ctxFrequencia = document.getElementById('graficoFrequencia').getContext('2d');
    graficoFrequencia = new Chart(ctxFrequencia, {
        type: 'line',
        data: dadosFrequencia,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Carregar dados iniciais
    carregarDadosRelatorio();
});

// Carregar dados do relatório
function carregarDadosRelatorio() {
    // Obter filtros do formulário
    const mes = document.getElementById('mes')?.value || 'Dezembro';
    const atividade = document.getElementById('atividade')?.value || '';
    const turma = document.getElementById('turma')?.value || '';
    
    // Construir URL com parâmetros
    const params = new URLSearchParams({
        mes: mes,
        atividade: atividade,
        turma: turma
    });
    
    // Fazer requisição para o backend
    fetch('/obter_dados_relatorio?' + params.toString(), {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            preencherTabela(data.dados);
            atualizarEstatisticas(data.dados);
            
            // Atualizar gráficos com dados reais
            atualizarGraficos(data.dados);
        } else {
            console.error('Erro ao carregar dados:', data.message);
            // Fallback para dados de exemplo em caso de erro
            const dadosExemplo = [
                { nome: 'João Silva', atividade: 'Futebol', turma: 'Manhã', presencas: 8, faltas: 2, taxa: 80, status: 'Ativo' },
                { nome: 'Maria Santos', atividade: 'Vôlei', turma: 'Tarde', presencas: 9, faltas: 1, taxa: 90, status: 'Ativo' },
                { nome: 'Pedro Costa', atividade: 'Basquete', turma: 'Noite', presencas: 7, faltas: 3, taxa: 70, status: 'Ativo' }
            ];
            preencherTabela(dadosExemplo);
            atualizarEstatisticas(dadosExemplo);
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
        // Fallback para dados de exemplo em caso de erro
        const dadosExemplo = [
            { nome: 'João Silva', atividade: 'Futebol', turma: 'Manhã', presencas: 8, faltas: 2, taxa: 80, status: 'Ativo' },
            { nome: 'Maria Santos', atividade: 'Vôlei', turma: 'Tarde', presencas: 9, faltas: 1, taxa: 90, status: 'Ativo' },
            { nome: 'Pedro Costa', atividade: 'Basquete', turma: 'Noite', presencas: 7, faltas: 3, taxa: 70, status: 'Ativo' }
        ];
        preencherTabela(dadosExemplo);
        atualizarEstatisticas(dadosExemplo);
    });
}

// Preencher tabela com dados
function preencherTabela(dados) {
    const tbody = document.querySelector('#tabelaRelatorio tbody');
    tbody.innerHTML = '';

    dados.forEach(aluno => {
        const row = document.createElement('tr');
        row.innerHTML = '
            <td>' + aluno.nome + '</td>
            <td>' + aluno.atividade + '</td>
            <td>' + aluno.turma + '</td>
            <td>' + aluno.presencas + '</td>
            <td>' + aluno.faltas + '</td>
            <td>' + aluno.taxa + '%</td>
            <td><span class="badge bg-success">' + aluno.status + '</span></td>
        ';
        tbody.appendChild(row);
    });
}

// Atualizar estatísticas
function atualizarEstatisticas(dados) {
    const totalAlunos = dados.length;
    const totalPresencas = dados.reduce((sum, aluno) => sum + aluno.presencas, 0);
    const totalFaltas = dados.reduce((sum, aluno) => sum + aluno.faltas, 0);
    const taxaGeral = totalPresencas + totalFaltas > 0 ? 
        Math.round((totalPresencas / (totalPresencas + totalFaltas)) * 100) : 0;

    document.getElementById('total-alunos').textContent = totalAlunos;
    document.getElementById('total-presencas').textContent = totalPresencas;
    document.getElementById('total-faltas').textContent = totalFaltas;
    document.getElementById('taxa-geral').textContent = taxaGeral + '%';
}

// Atualizar gráficos com dados reais
function atualizarGraficos(dados) {
    // Contar alunos por atividade
    const atividadeCount = {};
    dados.forEach(aluno => {
        const atividade = aluno.atividade;
        atividadeCount[atividade] = (atividadeCount[atividade] || 0) + 1;
    });
    
    // Atualizar gráfico de atividades
    if (graficoAtividades) {
        graficoAtividades.data.labels = Object.keys(atividadeCount);
        graficoAtividades.data.datasets[0].data = Object.values(atividadeCount);
        graficoAtividades.update();
    }
    
    // Calcular dados de frequência por semana (simulado)
    const frequenciaSemanas = [];
    for (let i = 1; i <= 4; i++) {
        const mediaPresencas = dados.reduce((sum, aluno) => sum + aluno.presencas, 0) / dados.length;
        frequenciaSemanas.push(Math.round(mediaPresencas * (0.8 + Math.random() * 0.4))); // Variação simulada
    }
    
    // Atualizar gráfico de frequência
    if (graficoFrequencia) {
        graficoFrequencia.data.datasets[0].data = frequenciaSemanas;
        graficoFrequencia.update();
    }
}

// Exportar relatório
function exportarRelatorio() {
    // Aqui você implementaria a lógica para exportar o relatório
    alert('Funcionalidade de exportação será implementada em breve.');
}

// Imprimir relatório
function imprimirRelatorio() {
    window.print();
}

// Atualizar gráficos quando mudar filtros
document.getElementById('mes').addEventListener('change', function() {
    // Aqui você implementaria a lógica para atualizar os dados baseado no mês selecionado
    console.log('Mês selecionado:', this.value);
});

document.getElementById('atividade').addEventListener('change', function() {
    // Aqui você implementaria a lógica para atualizar os dados baseado na atividade selecionada
    console.log('Atividade selecionada:', this.value);
});

document.getElementById('tipo_relatorio').addEventListener('change', function() {
    // Aqui você implementaria a lógica para mudar o tipo de relatório
    console.log('Tipo de relatório selecionado:', this.value);
});
</script>
{% endblock %}
