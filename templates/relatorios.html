{% extends "base.html" %}

{% block title %}Relatórios - Associação Amigo do Povo{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 text-center mb-4">
            <i class="fas fa-chart-bar text-info"></i>
            Relatórios Mensais
        </h1>
    </div>
</div>

<!-- Seleção de Mês -->
<div class="row mb-4">
    <div class="col-md-6 mx-auto">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Selecionar Mês
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for mes in meses %}
                    <div class="col-md-4 col-sm-6 mb-2">
                        <button class="btn btn-outline-primary w-100 btn-mes {% if mes == mes_selecionado %}active{% endif %}" 
                                data-mes="{{ mes }}">
                            <i class="fas fa-calendar-day me-1"></i>
                            {{ mes }}
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading -->
<div id="loading" class="text-center" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-2">Carregando relatório...</p>
</div>

<!-- Área dos Relatórios -->
<div id="relatorio-content">
    <!-- Estatísticas Gerais -->
    <div class="row mb-4" id="estatisticas" style="display: none;">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h4 id="total-alunos">0</h4>
                    <p class="card-text mb-0">Total de Alunos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h4 id="total-presencas">0</h4>
                    <p class="card-text mb-0">Total Presenças</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <i class="fas fa-times-circle fa-2x mb-2"></i>
                    <h4 id="total-faltas">0</h4>
                    <p class="card-text mb-0">Total Faltas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-check fa-2x mb-2"></i>
                    <h4 id="dias-aula">0</h4>
                    <p class="card-text mb-0">Dias com Aula</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Presenças por Dia -->
    <div class="row mb-4" id="grafico-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Presenças por Dia do Mês
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="grafico-presencas" width="400" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Ranking de Alunos -->
    <div class="row" id="ranking-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>
                        Ranking de Frequência - <span id="mes-titulo"></span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Posição</th>
                                    <th>Aluno</th>
                                    <th>Presenças</th>
                                    <th>Faltas</th>
                                    <th>Total Aulas</th>
                                    <th>Frequência</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Área de Erro -->
<div id="erro-content" style="display: none;">
    <div class="alert alert-danger text-center">
        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
        <h4>Erro ao Carregar Relatório</h4>
        <p id="erro-mensagem"></p>
        <button class="btn btn-outline-danger" onclick="location.reload()">
            <i class="fas fa-sync-alt me-2"></i>
            Tentar Novamente
        </button>
    </div>
</div>

<!-- Navegação -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary me-2">
            <i class="fas fa-chart-line me-2"></i>
            Dashboard
        </a>
        <a href="{{ url_for('alunos') }}" class="btn btn-outline-secondary">
            <i class="fas fa-users me-2"></i>
            Ver Alunos
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let graficoPresencas;

$(document).ready(function() {
    // Carregar relatório do mês atual
    const mesAtual = $('.btn-mes.active').data('mes');
    if (mesAtual) {
        carregarRelatorio(mesAtual);
    }
    
    // Event listener para botões de mês
    $('.btn-mes').on('click', function() {
        const mes = $(this).data('mes');
        
        // Atualizar botões ativos
        $('.btn-mes').removeClass('active');
        $(this).addClass('active');
        
        // Carregar relatório
        carregarRelatorio(mes);
    });
});

function carregarRelatorio(mes) {
    // Mostrar loading
    $('#loading').show();
    $('#relatorio-content').hide();
    $('#erro-content').hide();
    
    // Fazer requisição
    $.ajax({
        url: `/relatorio_mes/${mes}`,
        method: 'GET',
        success: function(data) {
            if (data.error) {
                mostrarErro(data.error);
            } else {
                mostrarRelatorio(data);
            }
        },
        error: function() {
            mostrarErro('Erro de conexão com o servidor');
        },
        complete: function() {
            $('#loading').hide();
        }
    });
}

function mostrarRelatorio(dados) {
    // Atualizar estatísticas
    $('#total-alunos').text(dados.total_alunos);
    $('#total-presencas').text(dados.estatisticas.total_presencas);
    $('#total-faltas').text(dados.estatisticas.total_faltas);
    $('#dias-aula').text(dados.estatisticas.dias_com_aula);
    $('#mes-titulo').text(dados.mes);
    
    // Mostrar seções
    $('#estatisticas').show();
    $('#grafico-section').show();
    $('#ranking-section').show();
    $('#relatorio-content').show();
    
    // Criar gráfico
    criarGrafico(dados.presencas_por_dia, dados.mes);
    
    // Criar ranking
    criarRanking(dados.presencas_por_aluno);
}

function criarGrafico(presencasPorDia, mes) {
    const ctx = document.getElementById('grafico-presencas').getContext('2d');
    
    // Destruir gráfico anterior se existir
    if (graficoPresencas) {
        graficoPresencas.destroy();
    }
    
    // Preparar dados
    const dias = [];
    const presencas = [];
    
    for (let dia = 1; dia <= 31; dia++) {
        dias.push(dia);
        presencas.push(presencasPorDia[dia] || 0);
    }
    
    graficoPresencas = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dias,
            datasets: [{
                label: 'Presenças',
                data: presencas,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Número de Presenças'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Dias do Mês'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `Presenças Diárias - ${mes} 2025`
                }
            }
        }
    });
}

function criarRanking(presencasPorAluno) {
    const tbody = $('#ranking-tbody');
    tbody.empty();
    
    // Converter objeto para array e ordenar
    const ranking = Object.entries(presencasPorAluno)
        .map(([nome, presencas]) => ({ nome, presencas }))
        .sort((a, b) => b.presencas - a.presencas);
    
    ranking.forEach((aluno, index) => {
        let posicaoIcon = '';
        if (index === 0) posicaoIcon = '🥇';
        else if (index === 1) posicaoIcon = '🥈';
        else if (index === 2) posicaoIcon = '🥉';
        else posicaoIcon = `${index + 1}º`;
        
        // Calcular percentual (assumindo que o máximo é 30 dias)
        const percentual = Math.round((aluno.presencas / 30) * 100);
        
        let badgeClass = 'bg-success';
        let status = 'Excelente';
        let icone = 'fa-trophy';
        
        if (percentual < 50) {
            badgeClass = 'bg-danger';
            status = 'Crítico';
            icone = 'fa-exclamation-triangle';
        } else if (percentual < 75) {
            badgeClass = 'bg-warning';
            status = 'Atenção';
            icone = 'fa-exclamation-circle';
        } else if (percentual < 90) {
            badgeClass = 'bg-info';
            status = 'Bom';
            icone = 'fa-check-circle';
        }
        
        const row = `
            <tr>
                <td>
                    <strong>${posicaoIcon}</strong>
                </td>
                <td>
                    <i class="fas fa-user text-primary me-1"></i>
                    ${aluno.nome}
                </td>
                <td>
                    <span class="badge bg-success">${aluno.presencas}</span>
                </td>
                <td>
                    <span class="badge bg-warning">-</span>
                </td>
                <td>
                    <strong>30</strong>
                </td>
                <td>
                    <div class="progress" style="width: 100px;">
                        <div class="progress-bar ${badgeClass}" role="progressbar" 
                             style="width: ${percentual}%" 
                             aria-valuenow="${percentual}" 
                             aria-valuemin="0" aria-valuemax="100">
                            ${percentual}%
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge ${badgeClass}">
                        <i class="fas ${icone} me-1"></i>
                        ${status}
                    </span>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function mostrarErro(mensagem) {
    $('#erro-mensagem').text(mensagem);
    $('#erro-content').show();
}
</script>
{% endblock %}
