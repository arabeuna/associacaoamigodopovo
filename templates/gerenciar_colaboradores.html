{% extends "base.html" %}

{% block title %}Gerenciar Colaboradores - Associação Amigo do Povo{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 text-center mb-4">
            <i class="fas fa-users-cog text-primary"></i>
            Gerenciamento de Colaboradores
        </h1>
        <p class="text-center text-muted">
            <i class="fas fa-crown text-warning"></i>
            Acesso exclusivo para Admin Master
        </p>
    </div>
</div>

<!-- Estatísticas dos Colaboradores -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-user-shield fa-2x mb-2"></i>
                <h3 class="card-title">{{ colaboradores | selectattr('nivel', 'equalto', 'admin') | list | length }}</h3>
                <p class="card-text">Administradores</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-chalkboard-teacher fa-2x mb-2"></i>
                <h3 class="card-title">{{ colaboradores | selectattr('nivel', 'equalto', 'usuario') | list | length }}</h3>
                <p class="card-text">Professores/Usuários</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3 class="card-title">{{ colaboradores | length }}</h3>
                <p class="card-text">Total Colaboradores</p>
            </div>
        </div>
    </div>
</div>

<!-- Botão para Adicionar Novo Colaborador -->
<div class="row mb-4">
    <div class="col-12">
        <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#modalNovoColaborador">
            <i class="fas fa-user-plus me-2"></i>
            Novo Colaborador
        </button>
    </div>
</div>

<!-- Lista de Colaboradores -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Lista de Colaboradores
                </h5>
            </div>
            <div class="card-body">
                {% if colaboradores %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>Username</th>
                                    <th>Nível</th>
                                    <th>Atividade</th>
                                    <th>Status</th>
                                    <th>Data Criação</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for colaborador in colaboradores %}
                                <tr id="colaborador-{{ colaborador.username }}">
                                    <td>
                                        <i class="fas fa-user text-secondary me-2"></i>
                                        {{ colaborador.nome }}
                                    </td>
                                    <td>
                                        <code>{{ colaborador.username }}</code>
                                    </td>
                                    <td>
                                        {% if colaborador.nivel == 'admin' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-user-shield me-1"></i>
                                                Administrador
                                            </span>
                                        {% else %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-chalkboard-teacher me-1"></i>
                                                Usuário/Professor
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if colaborador.atividade_responsavel %}
                                            <span class="badge bg-success">{{ colaborador.atividade_responsavel }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if colaborador.ativo %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                Ativo
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times-circle me-1"></i>
                                                Inativo
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ colaborador.data_criacao }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary" 
                                                    onclick="editarColaborador('{{ colaborador.username }}')"
                                                    title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" 
                                                    onclick="excluirColaborador('{{ colaborador.username }}', '{{ colaborador.nome }}')"
                                                    title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <p>Nenhum colaborador cadastrado ainda</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovoColaborador">
                            <i class="fas fa-user-plus me-2"></i>
                            Cadastrar Primeiro Colaborador
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Colaborador -->
<div class="modal fade" id="modalNovoColaborador" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>
                    Novo Colaborador
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNovoColaborador">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="novoUsername" class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="novoUsername" name="username" required>
                            <div class="form-text">Mínimo 4 caracteres, sem espaços</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="novoNome" class="form-label">Nome Completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="novoNome" name="nome" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="novaSenha" class="form-label">Senha <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="novaSenha" name="senha" required>
                            <div class="form-text">Mínimo 6 caracteres</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="novoNivel" class="form-label">Nível de Acesso <span class="text-danger">*</span></label>
                            <select class="form-select" id="novoNivel" name="nivel" required>
                                <option value="">Selecione...</option>
                                <option value="admin">Administrador</option>
                                <option value="usuario">Usuário/Professor</option>
                            </select>
                        </div>
                    </div>
                    <div class="row" id="divAtividadeResponsavel" style="display: none;">
                        <div class="col-12 mb-3">
                            <label for="novaAtividadeResponsavel" class="form-label">Atividade Responsável</label>
                            <select class="form-select" id="novaAtividadeResponsavel" name="atividade_responsavel">
                                <option value="">Selecione uma atividade...</option>
                                {% for atividade in atividades %}
                                <option value="{{ atividade }}">{{ atividade }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Para usuários/professores, selecione a atividade pela qual será responsável</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="salvarNovoColaborador()">
                    <i class="fas fa-save me-2"></i>Criar Colaborador
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Colaborador -->
<div class="modal fade" id="modalEditarColaborador" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>
                    Editar Colaborador
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarColaborador">
                    <input type="hidden" id="editarUsernameOriginal" name="username_original">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editarUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editarUsername" readonly>
                            <div class="form-text">Username não pode ser alterado</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editarNome" class="form-label">Nome Completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editarNome" name="nome" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editarNovaSenha" class="form-label">Nova Senha</label>
                            <input type="password" class="form-control" id="editarNovaSenha" name="nova_senha">
                            <div class="form-text">Deixe vazio para manter a senha atual</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editarNivel" class="form-label">Nível de Acesso <span class="text-danger">*</span></label>
                            <select class="form-select" id="editarNivel" name="nivel" required>
                                <option value="admin">Administrador</option>
                                <option value="usuario">Usuário/Professor</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editarAtivo" class="form-label">Status</label>
                            <select class="form-select" id="editarAtivo" name="ativo" required>
                                <option value="true">Ativo</option>
                                <option value="false">Inativo</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3" id="editarDivAtividadeResponsavel">
                            <label for="editarAtividadeResponsavel" class="form-label">Atividade Responsável</label>
                            <select class="form-select" id="editarAtividadeResponsavel" name="atividade_responsavel">
                                <option value="">Selecione uma atividade...</option>
                                {% for atividade in atividades %}
                                <option value="{{ atividade }}">{{ atividade }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="salvarEdicaoColaborador()">
                    <i class="fas fa-save me-2"></i>Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
$(document).ready(function() {
    // Mostrar/ocultar campo atividade baseado no nível
    $('#novoNivel').on('change', function() {
        const nivel = $(this).val();
        if (nivel === 'usuario') {
            $('#divAtividadeResponsavel').show();
        } else {
            $('#divAtividadeResponsavel').hide();
            $('#novaAtividadeResponsavel').val('');
        }
    });
    
    $('#editarNivel').on('change', function() {
        const nivel = $(this).val();
        if (nivel === 'usuario') {
            $('#editarDivAtividadeResponsavel').show();
        } else {
            $('#editarDivAtividadeResponsavel').hide();
            $('#editarAtividadeResponsavel').val('');
        }
    });
});

function salvarNovoColaborador() {
    const form = document.getElementById('formNovoColaborador');
    const formData = new FormData(form);
    
    // Validações
    const username = formData.get('username');
    const nome = formData.get('nome');
    const senha = formData.get('senha');
    const nivel = formData.get('nivel');
    
    if (!username || username.length < 4) {
        showToast('error', 'Username deve ter pelo menos 4 caracteres');
        return;
    }
    
    if (!nome || nome.length < 3) {
        showToast('error', 'Nome deve ter pelo menos 3 caracteres');
        return;
    }
    
    if (!senha || senha.length < 6) {
        showToast('error', 'Senha deve ter pelo menos 6 caracteres');
        return;
    }
    
    if (!nivel) {
        showToast('error', 'Selecione um nível de acesso');
        return;
    }
    
    // Enviar dados
    $.ajax({
        url: '/criar_colaborador',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                showToast('success', response.message);
                $('#modalNovoColaborador').modal('hide');
                // Recarregar página após 1 segundo
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('error', response.message);
            }
        },
        error: function() {
            showToast('error', 'Erro de conexão com o servidor');
        }
    });
}

function editarColaborador(username) {
    // Buscar dados do colaborador
    $.ajax({
        url: `/obter_colaborador/${username}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const colaborador = response.colaborador;
                
                // Preencher formulário
                $('#editarUsernameOriginal').val(username);
                $('#editarUsername').val(username);
                $('#editarNome').val(colaborador.nome);
                $('#editarNivel').val(colaborador.nivel);
                $('#editarAtivo').val(colaborador.ativo ? 'true' : 'false');
                
                if (colaborador.nivel === 'usuario') {
                    $('#editarDivAtividadeResponsavel').show();
                    $('#editarAtividadeResponsavel').val(colaborador.atividade_responsavel || '');
                } else {
                    $('#editarDivAtividadeResponsavel').hide();
                }
                
                // Mostrar modal
                $('#modalEditarColaborador').modal('show');
            } else {
                showToast('error', response.message);
            }
        },
        error: function() {
            showToast('error', 'Erro ao buscar dados do colaborador');
        }
    });
}

function salvarEdicaoColaborador() {
    const username = $('#editarUsernameOriginal').val();
    const form = document.getElementById('formEditarColaborador');
    const formData = new FormData(form);
    
    // Validações
    const nome = formData.get('nome');
    const nivel = formData.get('nivel');
    
    if (!nome || nome.length < 3) {
        showToast('error', 'Nome deve ter pelo menos 3 caracteres');
        return;
    }
    
    if (!nivel) {
        showToast('error', 'Selecione um nível de acesso');
        return;
    }
    
    // Enviar dados
    $.ajax({
        url: `/editar_colaborador/${username}`,
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                showToast('success', response.message);
                $('#modalEditarColaborador').modal('hide');
                // Recarregar página após 1 segundo
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('error', response.message);
            }
        },
        error: function() {
            showToast('error', 'Erro de conexão com o servidor');
        }
    });
}

function excluirColaborador(username, nome) {
    if (!confirm(`Tem certeza que deseja excluir o colaborador ${nome}?\n\nEsta ação não pode ser desfeita!`)) {
        return;
    }
    
    $.ajax({
        url: `/excluir_colaborador/${username}`,
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                showToast('success', response.message);
                // Remover linha da tabela
                $(`#colaborador-${username}`).fadeOut(500, function() {
                    $(this).remove();
                });
            } else {
                showToast('error', response.message);
            }
        },
        error: function() {
            showToast('error', 'Erro de conexão com o servidor');
        }
    });
}

function showToast(type, message) {
    const toastClass = type === 'success' ? 'bg-success' : 'bg-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
    
    const toast = $(`
        <div class="toast position-fixed top-0 end-0 m-3 ${toastClass} text-white" role="alert" style="z-index: 1055;">
            <div class="toast-header ${toastClass} text-white border-0">
                <i class="fas ${icon} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Sucesso' : 'Erro'}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `);
    
    $('body').append(toast);
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();
    
    // Remover do DOM após fechar
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}
</script>
{% endblock %}
