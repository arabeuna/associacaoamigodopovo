{% extends "base.html" %}
{% block title %}Logs de Atividades - Associação Amigo do Povo{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-list-alt text-info me-2"></i>Logs de Atividades</h2>
                <div class="text-muted">
                    <small>Monitoramento de atividades do sistema</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="filtroUsuario" class="form-label">Usuário:</label>
                                <select class="form-select" id="filtroUsuario">
                                    <option value="">Todos os usuários</option>
                                    <option value="admin">Administrador</option>
                                    <option value="admin_master">Admin Master</option>
                                    <option value="usuario">Usuário</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="filtroAcao" class="form-label">Ação:</label>
                                <select class="form-select" id="filtroAcao">
                                    <option value="">Todas as ações</option>
                                    <option value="login">Login</option>
                                    <option value="logout">Logout</option>
                                    <option value="criou">Criou</option>
                                    <option value="editou">Editou</option>
                                    <option value="excluiu">Excluiu</option>
                                    <option value="visualizou">Visualizou</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="filtroDataInicio" class="form-label">Data Início:</label>
                                <input type="date" class="form-control" id="filtroDataInicio">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="filtroDataFim" class="form-label">Data Fim:</label>
                                <input type="date" class="form-control" id="filtroDataFim">
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="aplicarFiltros()">
                            <i class="fas fa-search me-2"></i>Aplicar Filtros
                        </button>
                        <button class="btn btn-outline-secondary" onclick="limparFiltros()">
                            <i class="fas fa-eraser me-2"></i>Limpar
                        </button>
                        <button class="btn btn-success" onclick="exportarLogs()">
                            <i class="fas fa-download me-2"></i>Exportar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-list fa-2x mb-2"></i>
                    <h5 class="card-title" id="total-logs">0</h5>
                    <p class="card-text">Total de Logs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h5 class="card-title" id="usuarios-ativos">0</h5>
                    <p class="card-text">Usuários Ativos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h5 class="card-title" id="atividade-hoje">0</h5>
                    <p class="card-text">Atividades Hoje</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h5 class="card-title" id="alertas">0</h5>
                    <p class="card-text">Alertas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Atividades por Usuário</h5>
                </div>
                <div class="card-body">
                    <canvas id="usuariosChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Atividades por Dia</h5>
                </div>
                <div class="card-body">
                    <canvas id="atividadesChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Logs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Logs de Atividades</h5>
                    <div>
                        <span class="badge bg-primary me-2" id="logs-count">0 logs</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="atualizarLogs()">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Detalhes</th>
                                    <th>Tipo</th>
                                    <th>IP</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Carregando logs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Paginação -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="Navegação de logs">
                <ul class="pagination justify-content-center" id="paginacao">
                    <!-- Paginação será gerada dinamicamente -->
                </ul>
            </nav>
        </div>
    </div>

    <!-- Ações -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Ações</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-primary" onclick="limparLogsAntigos()">
                            <i class="fas fa-broom me-2"></i>Limpar Logs Antigos
                        </button>
                        <button class="btn btn-outline-warning" onclick="configurarRetencao()">
                            <i class="fas fa-cog me-2"></i>Configurar Retenção
                        </button>
                        <button class="btn btn-outline-info" onclick="gerarRelatorioLogs()">
                            <i class="fas fa-file-alt me-2"></i>Relatório de Logs
                        </button>
                        <button class="btn btn-outline-danger" onclick="backupLogs()">
                            <i class="fas fa-save me-2"></i>Backup de Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navegação -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
                </a>
                <div>
                    <a href="{{ url_for('gerenciar_colaboradores') }}" class="btn btn-outline-warning me-2">
                        <i class="fas fa-user-tie me-2"></i>Gerenciar Colaboradores
                    </a>
                    <a href="{{ url_for('backup_planilhas') }}" class="btn btn-outline-primary">
                        <i class="fas fa-download me-2"></i>Backup de Planilhas
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="detalhesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalhesModalBody">
                <!-- Conteúdo dinâmico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="copiarDetalhes()">Copiar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Configuração -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configuração de Retenção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="retencaoDias" class="form-label">Retenção de Logs (dias):</label>
                    <input type="number" class="form-control" id="retencaoDias" value="90" min="30" max="365">
                    <div class="form-text">Logs mais antigos serão automaticamente removidos</div>
                </div>
                <div class="mb-3">
                    <label for="maxLogs" class="form-label">Máximo de Logs:</label>
                    <input type="number" class="form-control" id="maxLogs" value="10000" min="1000" max="100000">
                    <div class="form-text">Limite máximo de logs armazenados</div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="backupAutomatico" checked>
                        <label class="form-check-label" for="backupAutomatico">
                            Backup automático antes da limpeza
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarConfiguracao()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição de Log -->
<div class="modal fade" id="editLogModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarLog">
                    <div class="mb-3">
                        <label for="editLogTimestamp" class="form-label">Timestamp</label>
                        <input type="text" class="form-control" id="editLogTimestamp" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editLogAcao" class="form-label">Ação</label>
                        <input type="text" class="form-control" id="editLogAcao" required>
                    </div>
                    <div class="mb-3">
                        <label for="editLogDetalhes" class="form-label">Detalhes</label>
                        <textarea class="form-control" id="editLogDetalhes" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editLogTipo" class="form-label">Tipo de Usuário</label>
                        <select class="form-select" id="editLogTipo" required>
                            <option value="usuario">Usuário</option>
                            <option value="admin">Administrador</option>
                            <option value="admin_master">Admin Master</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarEdicaoLog()">Salvar Alterações</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let usuariosChart, atividadesChart;
let logs = [];
let filtros = {};
let paginaAtual = 1;
var logsPorPagina = 50;

// Inicializar página
document.addEventListener('DOMContentLoaded', function() {
    inicializarGraficos();
    carregarLogs();
    atualizarEstatisticas();
});

// Inicializar gráficos
function inicializarGraficos() {
    // Gráfico de atividades por usuário
    var usuariosChartElement = document.getElementById('usuariosChart');
    if (!usuariosChartElement) return;
    var ctxUsuarios = usuariosChartElement.getContext('2d');
    usuariosChart = new Chart(ctxUsuarios, {
        type: 'doughnut',
        data: {
            labels: ['Admin', 'Admin Master', 'Usuário'],
            datasets: [{
                data: [40, 30, 30],
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Gráfico de atividades por dia
    var atividadesChartElement = document.getElementById('atividadesChart');
    if (!atividadesChartElement) return;
    var ctxAtividades = atividadesChartElement.getContext('2d');
    atividadesChart = new Chart(ctxAtividades, {
        type: 'bar',
        data: {
            labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
            datasets: [{
                label: 'Atividades',
                data: [65, 59, 80, 81, 56, 55, 40],
                backgroundColor: '#36A2EB',
                borderColor: '#2693e6',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Carregar logs
function carregarLogs() {
    // Simular carregamento de dados
    setTimeout(() => {
        logs = [
            {
                timestamp: '15/01/2024 14:30:25',
                usuario: 'admin',
                acao: 'Criou Atividade',
                detalhes: 'Criou a atividade "Capoeira" com professor João Silva',
                tipo: 'admin',
                ip: '192.168.1.100',
                data_completa: '2024-01-15T14:30:25'
            },
            {
                timestamp: '15/01/2024 14:25:10',
                usuario: 'admin_master',
                acao: 'Editou Colaborador',
                detalhes: 'Editou informações do colaborador Maria Santos',
                tipo: 'admin_master',
                ip: '192.168.1.101',
                data_completa: '2024-01-15T14:25:10'
            },
            {
                timestamp: '15/01/2024 14:20:15',
                usuario: 'usuario',
                acao: 'Registrou Presença',
                detalhes: 'Registrou presença de 15 alunos na atividade Capoeira',
                tipo: 'usuario',
                ip: '192.168.1.102',
                data_completa: '2024-01-15T14:20:15'
            }
        ];
        
        renderizarTabelaLogs();
        atualizarPaginacao();
    }, 1000);
}

// Renderizar tabela de logs
function renderizarTabelaLogs() {
    var tbody = document.getElementById('logsTableBody');
    
    if (logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-inbox me-2"></i>Nenhum log encontrado
                </td>
            </tr>
        `;
        return;
    }
    
    var inicio = (paginaAtual - 1) * logsPorPagina;
    var fim = inicio + logsPorPagina;
    var logsPagina = logs.slice(inicio, fim);
    
    tbody.innerHTML = logsPagina.map(function(log) { return '
        <tr>
            <td><small>' + log.timestamp + '</small></td>
            <td>
                <span class="badge bg-' + (log.tipo === 'admin' ? 'warning' : log.tipo === 'admin_master' ? 'danger' : 'info') + '">
                    ' + log.usuario + '
                </span>
            </td>
            <td><strong>' + log.acao + '</strong></td>
            <td>' + log.detalhes + '</td>
            <td>
                <span class="badge bg-secondary">' + log.tipo + '</span>
            </td>
            <td><small>' + log.ip + '</small></td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-info" onclick="verDetalhes(\'' + log.timestamp + '\')" title="Ver Detalhes">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-warning" onclick="editarLog(\'' + log.timestamp + '\')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="excluirLog(\'' + log.timestamp + '\')" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    '; }).join('');
}

// Atualizar paginação
function atualizarPaginacao() {
    var totalPaginas = Math.ceil(logs.length / logsPorPagina);
    var paginacao = document.getElementById('paginacao');
    
    if (totalPaginas <= 1) {
        paginacao.innerHTML = '';
        return;
    }
    
    let paginacaoHTML = '';
    
    // Botão anterior
    paginacaoHTML += '
        <li class="page-item ' + (paginaAtual === 1 ? 'disabled' : '') + '">
            <a class="page-link" href="#" onclick="mudarPagina(' + (paginaAtual - 1) + ')">Anterior</a>
        </li>
    ';
    
    // Páginas
    for (let i = 1; i <= totalPaginas; i++) {
        if (i === 1 || i === totalPaginas || (i >= paginaAtual - 2 && i <= paginaAtual + 2)) {
            paginacaoHTML += '
                <li class="page-item ' + (i === paginaAtual ? 'active' : '') + '">
                    <a class="page-link" href="#" onclick="mudarPagina(' + i + ')">' + i + '</a>
                </li>
            ';
        } else if (i === paginaAtual - 3 || i === paginaAtual + 3) {
            paginacaoHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // Botão próximo
    paginacaoHTML += '
        <li class="page-item ' + (paginaAtual === totalPaginas ? 'disabled' : '') + '">
            <a class="page-link" href="#" onclick="mudarPagina(' + (paginaAtual + 1) + ')">Próximo</a>
        </li>
    ';
    
    paginacao.innerHTML = paginacaoHTML;
}

// Mudar página
function mudarPagina(pagina) {
    if (pagina < 1 || pagina > Math.ceil(logs.length / logsPorPagina)) return;
    
    paginaAtual = pagina;
    renderizarTabelaLogs();
    atualizarPaginacao();
}

// Aplicar filtros
function aplicarFiltros() {
    var usuario = document.getElementById('filtroUsuario').value;
    var acao = document.getElementById('filtroAcao').value;
    var dataInicio = document.getElementById('filtroDataInicio').value;
    var dataFim = document.getElementById('filtroDataFim').value;
    
    filtros = { usuario, acao, dataInicio, dataFim };
    
    // Aqui você implementaria a lógica de filtro real
    console.log('Filtros aplicados:', filtros);
    
    // Simular filtro
    mostrarAlerta('Filtros aplicados com sucesso!', 'success');
}

// Limpar filtros
function limparFiltros() {
    document.getElementById('filtroUsuario').value = '';
    document.getElementById('filtroAcao').value = '';
    document.getElementById('filtroDataInicio').value = '';
    document.getElementById('filtroDataFim').value = '';
    
    filtros = {};
    mostrarAlerta('Filtros limpos!', 'info');
}

// Ver detalhes
function verDetalhes(timestamp) {
    var log = logs.find(l => l.timestamp === timestamp);
    if (!log) return;
    
    var modalBody = document.getElementById('detalhesModalBody');
    modalBody.innerHTML = '
        <div class="row">
            <div class="col-md-6">
                <h6>Informações Básicas</h6>
                <p><strong>Timestamp:</strong> ' + log.timestamp + '</p>
                <p><strong>Usuário:</strong> ' + log.usuario + '</p>
                <p><strong>Ação:</strong> ' + log.acao + '</p>
                <p><strong>Tipo:</strong> ' + log.tipo + '</p>
            </div>
            <div class="col-md-6">
                <h6>Detalhes Técnicos</h6>
                <p><strong>IP:</strong> ' + log.ip + '</p>
                <p><strong>Data Completa:</strong> ' + log.data_completa + '</p>
                <p><strong>Hash:</strong> ' + btoa(log.timestamp).slice(0, 16) + '...</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Detalhes da Ação</h6>
                <div class="alert alert-info">
                    ' + log.detalhes + '
                </div>
            </div>
        </div>
    ';
    
    var modal = new bootstrap.Modal(document.getElementById('detalhesModal'));
    modal.show();
}

// Editar log
function editarLog(timestamp) {
    var log = logs.find(l => l.timestamp === timestamp);
    if (!log) {
        mostrarAlerta('Log não encontrado', 'error');
        return;
    }
    
    // Preencher o formulário com os dados atuais do log
    document.getElementById('editLogTimestamp').value = log.timestamp;
    document.getElementById('editLogAcao').value = log.acao;
    document.getElementById('editLogDetalhes').value = log.detalhes;
    document.getElementById('editLogTipo').value = log.tipo;
    
    var modal = new bootstrap.Modal(document.getElementById('editLogModal'));
    modal.show();
}

// Salvar edição do log
function salvarEdicaoLog() {
    var timestamp = document.getElementById('editLogTimestamp').value;
    var acao = document.getElementById('editLogAcao').value.trim();
    var detalhes = document.getElementById('editLogDetalhes').value.trim();
    var tipo = document.getElementById('editLogTipo').value;
    
    // Validar dados
    if (!acao || !detalhes) {
        mostrarAlerta('Ação e detalhes são obrigatórios', 'warning');
        return;
    }
    
    // Mostrar loading
    var btnSalvar = document.querySelector('#editLogModal .btn-primary');
    var textoOriginal = btnSalvar.textContent;
    btnSalvar.textContent = 'Salvando...';
    btnSalvar.disabled = true;
    
    // Enviar para o backend
    fetch('/editar_log', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            timestamp_original: timestamp,
            acao: acao,
            detalhes: detalhes,
            tipo: tipo
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarAlerta(data.message, 'success');
            
            // Atualizar o log na lista local
            var logIndex = logs.findIndex(l => l.timestamp === timestamp);
            if (logIndex !== -1) {
                logs[logIndex].acao = acao;
                logs[logIndex].detalhes = detalhes;
                logs[logIndex].tipo = tipo;
            }
            
            // Atualizar a tabela
            renderizarTabelaLogs();
            
            // Fechar modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('editLogModal'));
            modal.hide();
        } else {
            mostrarAlerta(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarAlerta('Erro ao salvar edição do log', 'error');
    })
    .finally(() => {
        btnSalvar.textContent = textoOriginal;
        btnSalvar.disabled = false;
    });
}

// Excluir log
function excluirLog(timestamp) {
    if (confirm('Deseja realmente excluir o log de ' + timestamp + '?')) {
        logs = logs.filter(l => l.timestamp !== timestamp);
        renderizarTabelaLogs();
        atualizarPaginacao();
        atualizarEstatisticas();
        mostrarAlerta('Log excluído com sucesso!', 'success');
    }
}

// Atualizar logs
function atualizarLogs() {
    mostrarAlerta('Atualizando logs...', 'info');
    setTimeout(() => {
        carregarLogs();
        mostrarAlerta('Logs atualizados com sucesso!', 'success');
    }, 1000);
}

// Atualizar estatísticas
function atualizarEstatisticas() {
    document.getElementById('total-logs').textContent = logs.length;
    document.getElementById('usuarios-ativos').textContent = new Set(logs.map(l => l.usuario)).size;
    
    var hoje = new Date().toLocaleDateString('pt-BR');
    var atividadesHoje = logs.filter(l => l.timestamp.startsWith(hoje)).length;
    document.getElementById('atividade-hoje').textContent = atividadesHoje;
    
    document.getElementById('logs-count').textContent = logs.length + ' logs';
}

// Exportar logs
function exportarLogs() {
    var data = {
        logs: logs,
        filtros: filtros,
        exportTime: new Date().toISOString(),
        totalLogs: logs.length
    };

    var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'logs_atividades_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    mostrarAlerta('Logs exportados com sucesso!', 'success');
}

// Limpar logs antigos
function limparLogsAntigos() {
    if (confirm('Deseja limpar logs antigos? Esta ação não pode ser desfeita.')) {
        var dataLimite = new Date();
        dataLimite.setDate(dataLimite.getDate() - 90); // 90 dias atrás
        
        var logsAntigos = logs.filter(log => {
            var dataLog = new Date(log.data_completa);
            return dataLog < dataLimite;
        });
        
        if (logsAntigos.length === 0) {
            mostrarAlerta('Nenhum log antigo encontrado', 'info');
            return;
        }
        
        logs = logs.filter(log => {
            var dataLog = new Date(log.data_completa);
            return dataLog >= dataLimite;
        });
        
        renderizarTabelaLogs();
        atualizarPaginacao();
        atualizarEstatisticas();
        
        mostrarAlerta(logsAntigos.length + ' logs antigos removidos com sucesso!', 'success');
    }
}

// Configurar retenção
function configurarRetencao() {
    // Carregar configuração atual
    fetch('/obter_configuracao_logs')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            var config = data.config;
            document.getElementById('retencaoDias').value = config.retencao_dias || 90;
            document.getElementById('maxLogs').value = config.max_logs || 10000;
            document.getElementById('backupAutomatico').checked = config.backup_automatico !== false;
        }
    })
    .catch(error => {
        console.error('Erro ao carregar configuração:', error);
        // Usar valores padrão em caso de erro
        document.getElementById('retencaoDias').value = 90;
        document.getElementById('maxLogs').value = 10000;
        document.getElementById('backupAutomatico').checked = true;
    })
    .finally(() => {
        var modal = new bootstrap.Modal(document.getElementById('configModal'));
        modal.show();
    });
}

// Salvar configuração
function salvarConfiguracao() {
    var retencaoDias = parseInt(document.getElementById('retencaoDias').value);
    var maxLogs = parseInt(document.getElementById('maxLogs').value);
    var backupAutomatico = document.getElementById('backupAutomatico').checked;
    
    // Validar dados
    if (retencaoDias < 30 || retencaoDias > 365) {
        mostrarAlerta('Retenção deve ser entre 30 e 365 dias', 'warning');
        return;
    }
    
    if (maxLogs < 1000 || maxLogs > 100000) {
        mostrarAlerta('Máximo de logs deve ser entre 1.000 e 100.000', 'warning');
        return;
    }
    
    // Mostrar loading
    var btnSalvar = document.querySelector('#configModal .btn-primary');
    var textoOriginal = btnSalvar.textContent;
    btnSalvar.textContent = 'Salvando...';
    btnSalvar.disabled = true;
    
    // Enviar para o backend
    fetch('/configurar_retencao_logs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            retencao_dias: retencaoDias,
            max_logs: maxLogs,
            backup_automatico: backupAutomatico
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarAlerta(data.message, 'success');
            var modal = bootstrap.Modal.getInstance(document.getElementById('configModal'));
            modal.hide();
        } else {
            mostrarAlerta(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarAlerta('Erro ao salvar configuração', 'error');
    })
    .finally(() => {
        btnSalvar.textContent = textoOriginal;
        btnSalvar.disabled = false;
    });
}

// Gerar relatório de logs
function gerarRelatorioLogs() {
    mostrarAlerta('Gerando relatório de logs...', 'info');
    setTimeout(() => {
        mostrarAlerta('Relatório de logs gerado com sucesso!', 'success');
    }, 2000);
}

// Backup de logs
function backupLogs() {
    mostrarAlerta('Iniciando backup de logs...', 'info');
    setTimeout(() => {
        mostrarAlerta('Backup de logs concluído com sucesso!', 'success');
    }, 3000);
}

// Copiar detalhes
function copiarDetalhes() {
    var modalBody = document.getElementById('detalhesModalBody');
    var text = modalBody.textContent || modalBody.innerText;
    
    navigator.clipboard.writeText(text).then(() => {
        mostrarAlerta('Detalhes copiados para a área de transferência!', 'success');
    }).catch(() => {
        mostrarAlerta('Erro ao copiar detalhes', 'danger');
    });
}

// Funções auxiliares
function mostrarAlerta(mensagem, tipo) {
    var alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-' + tipo + ' alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = '
        ' + mensagem + '
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    ';
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Atualizar estatísticas a cada 30 segundos
setInterval(atualizarEstatisticas, 30000);
</script>
{% endblock %}
