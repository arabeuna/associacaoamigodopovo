{% extends "base.html" %}

{% block title %}Sistema - Status{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2>üîß Status do Sistema</h2>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5>üìä Status da Conex√£o</h5>
                </div>
                <div class="card-body">
                    <div id="status-info">
                        <p>Carregando status...</p>
                    </div>
                    <button class="btn btn-primary" onclick="atualizarStatus()">üîÑ Atualizar Status</button>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5>üíæ Registros Pendentes (Fallback)</h5>
                </div>
                <div class="card-body">
                    <div id="fallback-info">
                        <p>Verificando registros pendentes...</p>
                    </div>
                    <button class="btn btn-success" onclick="processarFallback()" id="btn-processar">‚ö° Processar Pendentes</button>
                </div>
            </div>
            
            {% if session.tipo_usuario == 'admin_master' %}
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5>‚ö†Ô∏è Administra√ß√£o Avan√ßada (Master)</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>ATEN√á√ÉO:</strong> As opera√ß√µes abaixo s√£o irrevers√≠veis e devem ser usadas com extremo cuidado.
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <h6 class="card-title text-warning">
                                        <i class="fas fa-database me-2"></i>
                                        Limpar Banco de Dados
                                    </h6>
                                    <p class="card-text small">
                                        Remove TODOS os dados do MongoDB (alunos, atividades, turmas, presen√ßas) e recria estruturas padr√£o.
                                    </p>
                                    <button class="btn btn-warning btn-sm" onclick="mostrarModalLimpeza()">
                                        <i class="fas fa-trash-alt me-2"></i>
                                        Limpar Banco
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-body">
                                    <h6 class="card-title text-info">
                                        <i class="fas fa-sync-alt me-2"></i>
                                        Sincronizar Dados
                                    </h6>
                                    <p class="card-text small">
                                        For√ßa sincroniza√ß√£o entre dados locais e MongoDB.
                                    </p>
                                    <button class="btn btn-info btn-sm" onclick="sincronizarDados()">
                                        <i class="fas fa-sync me-2"></i>
                                        Sincronizar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="card">
                <div class="card-header">
                    <h5>üìù Log de Atividades</h5>
                </div>
                <div class="card-body">
                    <div id="log-atividades" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <p>Aguardando atividades...</p>
                    </div>
                </div>
            </div>
            
            <!-- Modal de Confirma√ß√£o para Limpeza -->
            <div class="modal fade" id="modalLimpezaBanco" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                CONFIRMA√á√ÉO DE LIMPEZA
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger">
                                <strong>ATEN√á√ÉO:</strong> Esta opera√ß√£o ir√°:
                                <ul class="mt-2 mb-0">
                                    <li>Remover TODOS os alunos cadastrados</li>
                                    <li>Remover TODAS as atividades personalizadas</li>
                                    <li>Remover TODAS as turmas personalizadas</li>
                                    <li>Remover TODOS os dados de presen√ßa</li>
                                    <li>Recriar apenas estruturas padr√£o do sistema</li>
                                </ul>
                            </div>
                            
                            <p><strong>Esta a√ß√£o √© IRREVERS√çVEL!</strong></p>
                            
                            <div class="mb-3">
                                <label for="confirmacaoTexto" class="form-label">
                                    Para confirmar, digite: <code>LIMPAR_BANCO_CONFIRMADO</code>
                                </label>
                                <input type="text" class="form-control" id="confirmacaoTexto" placeholder="Digite a confirma√ß√£o...">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </button>
                            <button type="button" class="btn btn-danger" onclick="executarLimpezaBanco()" id="btnConfirmarLimpeza" disabled>
                                <i class="fas fa-trash-alt me-2"></i>
                                CONFIRMAR LIMPEZA
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let logCount = 0;

function adicionarLog(mensagem, tipo = 'info') {
    const logDiv = document.getElementById('log-atividades');
    const timestamp = new Date().toLocaleTimeString();
    const cor = tipo === 'error' ? 'text-danger' : tipo === 'success' ? 'text-success' : 'text-info';
    
    logDiv.innerHTML += `<div class="${cor}"><small>[${timestamp}]</small> ${mensagem}</div>`;
    logDiv.scrollTop = logDiv.scrollHeight;
    
    logCount++;
    if (logCount > 100) {
        // Limpar logs antigos
        const lines = logDiv.innerHTML.split('</div>');
        logDiv.innerHTML = lines.slice(-50).join('</div>');
        logCount = 50;
    }
}

function atualizarStatus() {
    adicionarLog('üîÑ Atualizando status do sistema...');
    
    fetch('/sistema/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const status = data.status;
                const statusHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Conex√£o com Banco:</strong> 
                                <span class="badge ${status.database_connected ? 'bg-success' : 'bg-danger'}">
                                    ${status.database_connected ? '‚úÖ Conectado' : '‚ùå Desconectado'}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Registros Pendentes:</strong> 
                                <span class="badge ${status.fallback_records > 0 ? 'bg-warning' : 'bg-success'}">
                                    ${status.fallback_records} registros
                                </span>
                            </p>
                        </div>
                    </div>
                    <p><small><strong>√öltima verifica√ß√£o:</strong> ${new Date(status.last_check).toLocaleString()}</small></p>
                `;
                
                document.getElementById('status-info').innerHTML = statusHtml;
                
                const fallbackHtml = status.fallback_records > 0 ? 
                    `<div class="alert alert-warning">‚ö†Ô∏è Existem ${status.fallback_records} registros aguardando processamento.</div>` :
                    `<div class="alert alert-success">‚úÖ Nenhum registro pendente.</div>`;
                
                document.getElementById('fallback-info').innerHTML = fallbackHtml;
                
                adicionarLog(`‚úÖ Status atualizado: Banco ${status.database_connected ? 'conectado' : 'desconectado'}, ${status.fallback_records} pendentes`, 'success');
            } else {
                adicionarLog(`‚ùå Erro ao obter status: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            adicionarLog(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
        });
}

function processarFallback() {
    const btn = document.getElementById('btn-processar');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Processando...';
    
    adicionarLog('‚ö° Iniciando processamento de registros pendentes...');
    
    fetch('/sistema/processar-fallback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const resultado = data.resultado;
            adicionarLog(`‚úÖ Processamento conclu√≠do: ${resultado.processed} processados, ${resultado.remaining} restantes`, 'success');
            
            if (resultado.errors && resultado.errors.length > 0) {
                resultado.errors.forEach(error => {
                    adicionarLog(`‚ö†Ô∏è ${error}`, 'error');
                });
            }
            
            // Atualizar status ap√≥s processamento
            setTimeout(atualizarStatus, 1000);
        } else {
            adicionarLog(`‚ùå Erro no processamento: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        adicionarLog(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '‚ö° Processar Pendentes';
    });
}

// Fun√ß√µes para limpeza do banco de dados
function mostrarModalLimpeza() {
    const modal = new bootstrap.Modal(document.getElementById('modalLimpezaBanco'));
    modal.show();
    
    // Resetar campos
    document.getElementById('confirmacaoTexto').value = '';
    document.getElementById('btnConfirmarLimpeza').disabled = true;
}

// Habilitar bot√£o de confirma√ß√£o apenas quando texto correto for digitado
document.addEventListener('DOMContentLoaded', function() {
    const confirmacaoInput = document.getElementById('confirmacaoTexto');
    const btnConfirmar = document.getElementById('btnConfirmarLimpeza');
    
    if (confirmacaoInput && btnConfirmar) {
        confirmacaoInput.addEventListener('input', function() {
            btnConfirmar.disabled = this.value !== 'LIMPAR_BANCO_CONFIRMADO';
        });
    }
});

function executarLimpezaBanco() {
    const confirmacao = document.getElementById('confirmacaoTexto').value;
    
    if (confirmacao !== 'LIMPAR_BANCO_CONFIRMADO') {
        alert('Confirma√ß√£o incorreta!');
        return;
    }
    
    const btn = document.getElementById('btnConfirmarLimpeza');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Limpando...';
    
    adicionarLog('üóëÔ∏è Iniciando limpeza do banco de dados...', 'info');
    
    fetch('/limpar_banco_dados', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            confirmacao: confirmacao
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            adicionarLog('‚úÖ Banco de dados limpo com sucesso!', 'success');
            adicionarLog(`üìä Estat√≠sticas: ${data.message}`, 'info');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalLimpezaBanco'));
            modal.hide();
            
            // Atualizar status
            setTimeout(atualizarStatus, 1000);
            
            alert('Banco de dados limpo com sucesso! O sistema est√° pronto para receber novos dados.');
        } else {
            adicionarLog(`‚ùå Erro na limpeza: ${data.error}`, 'error');
            alert(`Erro na limpeza: ${data.error}`);
        }
    })
    .catch(error => {
        adicionarLog(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
        alert(`Erro na requisi√ß√£o: ${error.message}`);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-trash-alt me-2"></i>CONFIRMAR LIMPEZA';
    });
}

function sincronizarDados() {
    adicionarLog('üîÑ Iniciando sincroniza√ß√£o de dados...', 'info');
    
    // Implementar sincroniza√ß√£o se necess√°rio
    fetch('/sistema/sincronizar', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            adicionarLog('‚úÖ Sincroniza√ß√£o conclu√≠da!', 'success');
        } else {
            adicionarLog(`‚ùå Erro na sincroniza√ß√£o: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        adicionarLog(`‚ùå Erro na sincroniza√ß√£o: ${error.message}`, 'error');
    });
}

// Atualizar status automaticamente a cada 30 segundos
setInterval(atualizarStatus, 30000);

// Carregar status inicial
document.addEventListener('DOMContentLoaded', atualizarStatus);
</script>
{% endblock %}
