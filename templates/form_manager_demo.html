{% extends "base.html" %}
{% block title %}FormManager Demo - Associação Amigo do Povo{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-flask text-warning me-2"></i>FormManager Demo</h2>
                <div class="text-muted">
                    <small>Demonstração de funcionalidades avançadas</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Descrição da Demo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-info-circle me-2"></i>Sobre esta Demonstração</h5>
                    <p class="card-text">
                        Esta página demonstra o uso do <strong>FormManager</strong> com padrão <strong>useMemo</strong> 
                        para otimização de performance em formulários complexos. O sistema permite gerenciar múltiplos 
                        formulários de forma eficiente, evitando re-renderizações desnecessárias.
                    </p>
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Dica:</strong> Experimente preencher os formulários e observe como o sistema 
                        otimiza as atualizações em tempo real.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulários de Demonstração -->
    <div class="row">
        <!-- Formulário de Cadastro de Aluno -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-plus me-2"></i>Cadastro de Aluno</h5>
                </div>
                <div class="card-body">
                    <form id="formAluno" class="form-demo">
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="nome" name="nome" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefone" class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="telefone" name="telefone">
                        </div>
                        <div class="mb-3">
                            <label for="atividade" class="form-label">Atividade</label>
                            <select class="form-select" id="atividade" name="atividade" required>
                                <option value="">Selecione uma atividade</option>
                                <option value="capoeira">Capoeira</option>
                                <option value="natacao">Natação</option>
                                <option value="karate">Karatê</option>
                                <option value="danca">Dança</option>
                                <option value="funcional">Funcional</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Cadastrar Aluno
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Formulário de Configurações -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Configurações do Sistema</h5>
                </div>
                <div class="card-body">
                    <form id="formConfig" class="form-demo">
                        <div class="mb-3">
                            <label for="nomeSistema" class="form-label">Nome do Sistema</label>
                            <input type="text" class="form-control" id="nomeSistema" name="nomeSistema" value="Associação Amigo do Povo">
                        </div>
                        <div class="mb-3">
                            <label for="versao" class="form-label">Versão</label>
                            <input type="text" class="form-control" id="versao" name="versao" value="2.0.0">
                        </div>
                        <div class="mb-3">
                            <label for="modoDebug" class="form-label">Modo Debug</label>
                            <select class="form-select" id="modoDebug" name="modoDebug">
                                <option value="false">Desativado</option>
                                <option value="true">Ativado</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="timeout" class="form-label">Timeout (segundos)</label>
                            <input type="number" class="form-control" id="timeout" name="timeout" value="30" min="5" max="300">
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>Salvar Configurações
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulário de Relatório -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Geração de Relatório</h5>
                </div>
                <div class="card-body">
                    <form id="formRelatorio" class="form-demo">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="tipoRelatorio" class="form-label">Tipo de Relatório</label>
                                    <select class="form-select" id="tipoRelatorio" name="tipoRelatorio" required>
                                        <option value="">Selecione o tipo</option>
                                        <option value="frequencia">Frequência</option>
                                        <option value="financeiro">Financeiro</option>
                                        <option value="atividades">Atividades</option>
                                        <option value="alunos">Alunos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="dataInicio" class="form-label">Data Início</label>
                                    <input type="date" class="form-control" id="dataInicio" name="dataInicio" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="dataFim" class="form-label">Data Fim</label>
                                    <input type="date" class="form-control" id="dataFim" name="dataFim" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="formato" class="form-label">Formato de Saída</label>
                                    <select class="form-select" id="formato" name="formato" required>
                                        <option value="pdf">PDF</option>
                                        <option value="excel">Excel</option>
                                        <option value="csv">CSV</option>
                                        <option value="html">HTML</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="filtros" class="form-label">Filtros Adicionais</label>
                                    <input type="text" class="form-control" id="filtros" name="filtros" placeholder="Ex: atividade=capoeira, idade>10">
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-info">
                                <i class="fas fa-file-alt me-2"></i>Gerar Relatório
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="previewRelatorio()">
                                <i class="fas fa-eye me-2"></i>Preview
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Status dos Formulários -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Status dos Formulários</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-success fs-6 p-3 mb-2">
                                    <i class="fas fa-check-circle fa-2x d-block mb-2"></i>
                                    <span id="statusAluno">Pronto</span>
                                </div>
                                <small class="text-muted">Formulário Aluno</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-success fs-6 p-3 mb-2">
                                    <i class="fas fa-check-circle fa-2x d-block mb-2"></i>
                                    <span id="statusConfig">Pronto</span>
                                </div>
                                <small class="text-muted">Formulário Config</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-success fs-6 p-3 mb-2">
                                    <i class="fas fa-check-circle fa-2x d-block mb-2"></i>
                                    <span id="statusRelatorio">Pronto</span>
                                </div>
                                <small class="text-muted">Formulário Relatório</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-info fs-6 p-3 mb-2">
                                    <i class="fas fa-sync-alt fa-2x d-block mb-2"></i>
                                    <span id="statusGeral">Sincronizado</span>
                                </div>
                                <small class="text-muted">Status Geral</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log de Atividades -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Log de Atividades</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Ação</th>
                                    <th>Formulário</th>
                                    <th>Status</th>
                                    <th>Detalhes</th>
                                </tr>
                            </thead>
                            <tbody id="logTableBody">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="fas fa-inbox me-2"></i>Nenhuma atividade registrada
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navegação -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
                </a>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="resetarFormularios()">
                        <i class="fas fa-undo me-2"></i>Resetar Formulários
                    </button>
                    <button class="btn btn-outline-success me-2" onclick="exportarDados()">
                        <i class="fas fa-download me-2"></i>Exportar Dados
                    </button>
                    <button class="btn btn-outline-warning" onclick="limparLog()">
                        <i class="fas fa-trash me-2"></i>Limpar Log
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Resultado -->
<div class="modal fade" id="resultadoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resultado da Operação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultadoModalBody">
                <!-- Conteúdo dinâmico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="copiarResultado()">Copiar Resultado</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// FormManager com useMemo pattern
class FormManager {
    constructor() {
        this.forms = new Map();
        this.memoizedValues = new Map();
        this.log = [];
        this.init();
    }

    init() {
        this.setupFormListeners();
        this.setupValidation();
        this.updateStatus();
        this.logActivity('Sistema inicializado', 'Sistema', 'success');
    }

    setupFormListeners() {
        var forms = document.querySelectorAll('.form-demo');
        forms.forEach(function(form) {
            var formId = form.id;
            this.forms.set(formId, {
                element: form,
                data: new FormData(form),
                valid: false,
                lastUpdate: Date.now()
            });

            // Listener para mudanças
            form.addEventListener('input', (e) => {
                this.handleFormChange(formId, e);
            });

            // Listener para submit
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleFormSubmit(formId);
            });
        });
    }

    setupValidation() {
        // Validação em tempo real
        document.addEventListener('input', (e) => {
            if (e.target.matches('.form-control, .form-select')) {
                this.validateField(e.target);
            }
        });
    }

    handleFormChange(formId, event) {
        var form = this.forms.get(formId);
        if (!form) return;

        // Atualizar dados do formulário
        form.data = new FormData(form.element);
        form.lastUpdate = Date.now();
        form.valid = this.validateForm(form.element);

        // Memoização de valores
        this.memoizeFormData(formId, form.data);
        
        // Atualizar status
        this.updateFormStatus(formId);
        this.logActivity('Formulário ' + formId + ' atualizado', formId, 'info');
    }

    handleFormSubmit(formId) {
        var form = this.forms.get(formId);
        if (!form || !form.valid) {
            this.showError('Formulário ' + formId + ' inválido');
            return;
        }

        // Simular envio
        this.showLoading(formId);
        
        fetch('/demo_submit', {
            method: 'POST',
            body: form.data
        })
        .then(response => response.json())
        .then(data => {
            this.showResult(data);
            this.logActivity('Formulário ' + formId + ' enviado com sucesso', formId, 'success');
        })
        .catch(error => {
            this.showError('Erro ao enviar formulário: ' + error.message);
            this.logActivity('Erro ao enviar ' + formId, formId, 'error');
        })
        .finally(() => {
            this.hideLoading(formId);
        });
    }

    validateField(field) {
        var isValid = field.checkValidity();
        field.classList.toggle('is-invalid', !isValid);
        field.classList.toggle('is-valid', isValid);
        return isValid;
    }

    validateForm(form) {
        var fields = form.querySelectorAll('.form-control, .form-select');
        let isValid = true;
        
        fields.forEach(field => {
            if (!this.validateField(field)) {
                isValid = false;
            }
        });

        return isValid;
    }

    memoizeFormData(formId, formData) {
        const key = formId + '_' + Date.now();
        const data = Object.fromEntries(formData.entries());
        
        // Usar useMemo pattern para evitar recálculos desnecessários
        if (!this.memoizedValues.has(formId) || 
            JSON.stringify(this.memoizedValues.get(formId)) !== JSON.stringify(data)) {
            this.memoizedValues.set(formId, data);
        }
    }

    updateFormStatus(formId) {
        const form = this.forms.get(formId);
        const statusElement = document.getElementById('status' + formId.charAt(0).toUpperCase() + formId.slice(1));
        
        if (statusElement) {
            if (form.valid) {
                statusElement.textContent = 'Válido';
                statusElement.parentElement.className = 'badge bg-success fs-6 p-3 mb-2';
            } else {
                statusElement.textContent = 'Inválido';
                statusElement.parentElement.className = 'badge bg-danger fs-6 p-3 mb-2';
            }
        }
    }

    updateStatus() {
        const allValid = Array.from(this.forms.values()).every(form => form.valid);
        const statusGeral = document.getElementById('statusGeral');
        
        if (statusGeral) {
            if (allValid) {
                statusGeral.textContent = 'Todos Válidos';
                statusGeral.parentElement.className = 'badge bg-success fs-6 p-3 mb-2';
            } else {
                statusGeral.textContent = 'Pendente';
                statusGeral.parentElement.className = 'badge bg-warning fs-6 p-3 mb-2';
            }
        }
    }

    showLoading(formId) {
        const submitBtn = document.querySelector('#' + formId + ' button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
            submitBtn.disabled = true;
        }
    }

    hideLoading(formId) {
        const submitBtn = document.querySelector('#' + formId + ' button[type="submit"]');
        if (submitBtn) {
            const originalText = submitBtn.getAttribute('data-original-text') || 'Enviar';
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    showResult(data) {
        const modalBody = document.getElementById('resultadoModalBody');
        modalBody.innerHTML = '<div class="alert alert-' + (data.success ? 'success' : 'danger') + '"><h6>' + data.message + '</h6>' + (data.data ? '<pre class="mt-3">' + JSON.stringify(data.data, null, 2) + '</pre>' : '') + '</div>';
        
        const modal = new bootstrap.Modal(document.getElementById('resultadoModal'));
        modal.show();
    }

    showError(message) {
        this.showAlert(message, 'danger');
    }

    showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    logActivity(action, form, status) {
        const logEntry = {
            timestamp: new Date().toLocaleTimeString(),
            action: action,
            form: form,
            status: status,
            details: 'Operação realizada em ' + new Date().toLocaleString()
        };

        this.log.unshift(logEntry);
        this.updateLogTable();
        
        // Manter apenas os últimos 50 logs
        if (this.log.length > 50) {
            this.log = this.log.slice(0, 50);
        }
    }

    updateLogTable() {
        const tbody = document.getElementById('logTableBody');
        if (!tbody) return;

        if (this.log.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-inbox me-2"></i>Nenhuma atividade registrada</td></tr>';
            return;
        }

        tbody.innerHTML = this.log.map(entry => '<tr><td><small>' + entry.timestamp + '</small></td><td>' + entry.action + '</td><td><span class="badge bg-secondary">' + entry.form + '</span></td><td><span class="badge bg-' + (entry.status === 'success' ? 'success' : entry.status === 'error' ? 'danger' : 'info') + '">' + entry.status + '</span></td><td><small>' + entry.details + '</small></td></tr>').join('');
    }

    resetForms() {
        this.forms.forEach((form, formId) => {
            form.element.reset();
            form.data = new FormData(form.element);
            form.valid = false;
            form.lastUpdate = Date.now();
            this.updateFormStatus(formId);
        });
        
        this.updateStatus();
        this.logActivity('Todos os formulários resetados', 'Sistema', 'info');
        this.showAlert('Formulários resetados com sucesso!', 'success');
    }

    exportData() {
        const data = {
            forms: Array.from(this.forms.entries()).map(([id, form]) => ({
                id: id,
                data: Object.fromEntries(form.data.entries()),
                valid: form.valid,
                lastUpdate: form.lastUpdate
            })),
            memoizedValues: Array.from(this.memoizedValues.entries()),
            log: this.log,
            exportTime: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'formmanager_demo_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        this.logActivity('Dados exportados', 'Sistema', 'success');
        this.showAlert('Dados exportados com sucesso!', 'success');
    }

    clearLog() {
        this.log = [];
        this.updateLogTable();
        this.logActivity('Log limpo', 'Sistema', 'info');
        this.showAlert('Log limpo com sucesso!', 'success');
    }
}

// Inicializar FormManager
let formManager;

document.addEventListener('DOMContentLoaded', function() {
    formManager = new FormManager();
    
    // Salvar textos originais dos botões
    document.querySelectorAll('button[type="submit"]').forEach(btn => {
        btn.setAttribute('data-original-text', btn.innerHTML);
    });
});

// Funções globais
function resetarFormularios() {
    if (formManager) {
        formManager.resetForms();
    }
}

function exportarDados() {
    if (formManager) {
        formManager.exportData();
    }
}

function limparLog() {
    if (formManager) {
        formManager.clearLog();
    }
}

function previewRelatorio() {
    formManager.showAlert('Preview do relatório em desenvolvimento', 'info');
}

function copiarResultado() {
    const modalBody = document.getElementById('resultadoModalBody');
    const text = modalBody.textContent || modalBody.innerText;
    
    navigator.clipboard.writeText(text).then(() => {
        formManager.showAlert('Resultado copiado para a área de transferência!', 'success');
    }).catch(() => {
        formManager.showAlert('Erro ao copiar resultado', 'danger');
    });
}

// Atualizar status a cada segundo
setInterval(() => {
    if (formManager) {
        formManager.updateStatus();
    }
}, 1000);
</script>
{% endblock %}
