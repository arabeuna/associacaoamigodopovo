{% extends "base.html" %}

{% block title %}Presença - Associação Amigo do Povo{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 text-center mb-4">
                <i class="fas fa-calendar-check text-primary"></i>
                Controle de Presença
            </h1>
            <p class="text-muted text-center">Gerencie a presença dos alunos nas atividades</p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Filtros
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="atividade" class="form-label">Atividade</label>
                            <select name="atividade" id="atividade" class="form-select">
                                <option value="">Todas as atividades</option>
                                <option value="Futebol">Futebol</option>
                                <option value="Vôlei">Vôlei</option>
                                <option value="Basquete">Basquete</option>
                                <option value="Jiu-Jitsu">Jiu-Jitsu</option>
                                <option value="Capoeira">Capoeira</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="turma" class="form-label">Turma</label>
                            <select name="turma" id="turma" class="form-select">
                                <option value="">Todas as turmas</option>
                                <option value="Manhã">Manhã</option>
                                <option value="Tarde">Tarde</option>
                                <option value="Noite">Noite</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="data" class="form-label">Data</label>
                            <input type="date" name="data" id="data" class="form-control" value="{{ request.args.get('data', '') }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>
                                    Filtrar
                                </button>
                                <a href="{{ url_for('presenca') }}" class="btn btn-secondary ms-2">
                                    <i class="fas fa-undo me-2"></i>
                                    Limpar
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Alunos para Presença -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Lista de Alunos
                    </h5>
                    <div>
                        <button class="btn btn-success" onclick="marcarTodosPresentes()">
                            <i class="fas fa-check-double me-2"></i>
                            Marcar Todos Presentes
                        </button>
                        <button class="btn btn-danger" onclick="marcarTodosFaltaram()">
                            <i class="fas fa-times me-2"></i>
                            Marcar Todos Faltaram
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if alunos %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nome</th>
                                    <th>Atividade</th>
                                    <th>Turma</th>
                                    <th>Status</th>
                                    <th>Observações</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aluno in alunos %}
                                <tr>
                                    <td>{{ aluno.nome }}</td>
                                    <td>{{ aluno.atividade }}</td>
                                    <td>{{ aluno.turma }}</td>
                                    <td>
                                        <select class="form-select form-select-sm status-presenca" 
                                                data-aluno="{{ aluno.nome }}"
                                                onchange="atualizarStatus('{{ aluno.nome }}', this.value)">
                                            <option value="">Selecione</option>
                                            <option value="P" {% if aluno.status == 'P' %}selected{% endif %}>Presente</option>
                                            <option value="F" {% if aluno.status == 'F' %}selected{% endif %}>Faltou</option>
                                            <option value="J" {% if aluno.status == 'J' %}selected{% endif %}>Justificada</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm observacoes-presenca" 
                                               placeholder="Observações"
                                               data-aluno="{{ aluno.nome }}"
                                               value="{{ aluno.observacoes or '' }}">
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="salvarPresenca('{{ aluno.nome }}')">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        Nenhum aluno encontrado com os filtros aplicados.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo da Presença -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-check fa-2x text-success mb-2"></i>
                    <h4 id="total-presentes">0</h4>
                    <p class="text-muted mb-0">Presentes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-times fa-2x text-danger mb-2"></i>
                    <h4 id="total-faltas">0</h4>
                    <p class="text-muted mb-0">Faltas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar-minus fa-2x text-warning mb-2"></i>
                    <h4 id="total-justificadas">0</h4>
                    <p class="text-muted mb-0">Justificadas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                    <h4 id="taxa-presenca">0%</h4>
                    <p class="text-muted mb-0">Taxa de Presença</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="row">
        <div class="col-12 text-center">
            <button class="btn btn-lg btn-primary" onclick="salvarTodasPresencas()">
                <i class="fas fa-save me-2"></i>
                Salvar Todas as Presenças
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-lg btn-secondary ms-3">
                <i class="fas fa-arrow-left me-2"></i>
                Voltar ao Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Atualizar estatísticas
function atualizarEstatisticas() {
    var presentes = document.querySelectorAll('.status-presenca[value="P"]').length;
    var faltas = document.querySelectorAll('.status-presenca[value="F"]').length;
    var justificadas = document.querySelectorAll('.status-presenca[value="J"]').length;
    var total = presentes + faltas + justificadas;
    
    document.getElementById('total-presentes').textContent = presentes;
    document.getElementById('total-faltas').textContent = faltas;
    document.getElementById('total-justificadas').textContent = justificadas;
    
    if (total > 0) {
        var taxa = ((presentes / total) * 100).toFixed(1);
        document.getElementById('taxa-presenca').textContent = taxa + '%';
    } else {
        document.getElementById('taxa-presenca').textContent = '0%';
    }
}

// Atualizar status de presença
function atualizarStatus(aluno, status) {
    // Aqui você pode implementar a lógica para salvar no banco
    console.log('Aluno: ' + aluno + ', Status: ' + status);
    atualizarEstatisticas();
}

// Marcar todos como presentes
function marcarTodosPresentes() {
    document.querySelectorAll('.status-presenca').forEach(function(select) {
        select.value = 'P';
    });
    atualizarEstatisticas();
}

// Marcar todos como faltaram
function marcarTodosFaltaram() {
    document.querySelectorAll('.status-presenca').forEach(function(select) {
        select.value = 'F';
    });
    atualizarEstatisticas();
}

// Salvar presença individual
function salvarPresenca(aluno) {
    var status = document.querySelector('.status-presenca[data-aluno="' + aluno + '"]').value;
    var observacoes = document.querySelector('.observacoes-presenca[data-aluno="' + aluno + '"]').value;
    var dataInput = document.getElementById('data');
    var data = dataInput ? dataInput.value : new Date().toISOString().split('T')[0];
    
    if (!status) {
        alert('Selecione um status para o aluno ' + aluno);
        return;
    }
    
    // Fazer requisição para salvar no backend
    fetch('/salvar_presenca', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            aluno: aluno,
            status: status,
            observacoes: observacoes,
            data: data
        })
    })
    .then(response => response.json())
    .then(function(data) {
        if (data.success) {
            // Mostrar toast de sucesso
            mostrarToast(data.message, 'success');
            
            // Desabilitar os campos para este aluno
            var statusSelect = document.querySelector('.status-presenca[data-aluno="' + aluno + '"]');
            var obsTextarea = document.querySelector('.observacoes-presenca[data-aluno="' + aluno + '"]');
            var saveButton = document.querySelector('button[onclick="salvarPresenca(\'' + aluno + '\')"');
            
            if (statusSelect) statusSelect.disabled = true;
            if (obsTextarea) obsTextarea.disabled = true;
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-check"></i> Salvo';
                saveButton.classList.remove('btn-primary');
                saveButton.classList.add('btn-success');
            }
        } else {
            mostrarToast(data.message, 'error');
        }
    })
    .catch(function(error) {
        console.error('Erro ao salvar presença:', error);
        mostrarToast('Erro ao salvar presença. Tente novamente.', 'error');
    });
}

// Salvar todas as presenças
function salvarTodasPresencas() {
    var presencas = [];
    var dataInput = document.getElementById('data');
    var data = dataInput ? dataInput.value : new Date().toISOString().split('T')[0];
    
    document.querySelectorAll('.status-presenca').forEach(function(select) {
        var aluno = select.dataset.aluno;
        var status = select.value;
        var observacoes = document.querySelector('.observacoes-presenca[data-aluno="' + aluno + '"]').value;
        
        if (status && !select.disabled) { // Só incluir se não foi salvo ainda
            presencas.push({ aluno, status, observacoes });
        }
    });
    
    if (presencas.length === 0) {
        mostrarToast('Nenhuma presença para salvar. Selecione pelo menos um status ou todas já foram salvas.', 'warning');
        return;
    }
    
    // Desabilitar botão durante o salvamento
    var botaoSalvar = document.querySelector('button[onclick="salvarTodasPresencas()"]');
    if (botaoSalvar) {
        botaoSalvar.disabled = true;
        botaoSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
    }
    
    // Fazer requisição para salvar todas no backend
    fetch('/salvar_todas_presencas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            presencas: presencas,
            data: data
        })
    })
    .then(response => response.json())
    .then(function(data) {
        if (data.success) {
            mostrarToast(data.message, 'success');
            
            // Desabilitar todos os campos salvos com sucesso
            presencas.forEach(function(presenca) {
                var statusSelect = document.querySelector('.status-presenca[data-aluno="' + presenca.aluno + '"]');
                var obsTextarea = document.querySelector('.observacoes-presenca[data-aluno="' + presenca.aluno + '"]');
                var saveButton = document.querySelector('button[onclick="salvarPresenca(\'' + presenca.aluno + '\')"');
                
                if (statusSelect) statusSelect.disabled = true;
                if (obsTextarea) obsTextarea.disabled = true;
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<i class="fas fa-check"></i> Salvo';
                    saveButton.classList.remove('btn-primary');
                    saveButton.classList.add('btn-success');
                }
            });
            
            // Mostrar erros se houver
            if (data.erros && data.erros.length > 0) {
                console.warn('Erros encontrados:', data.erros);
                mostrarToast('Alguns erros ocorreram. Verifique o console para detalhes.', 'warning');
            }
        } else {
            mostrarToast(data.message, 'error');
            if (data.erros && data.erros.length > 0) {
                console.error('Erros:', data.erros);
            }
        }
    })
    .catch(function(error) {
        console.error('Erro ao salvar presenças:', error);
        mostrarToast('Erro ao salvar presenças. Tente novamente.', 'error');
    })
    .finally(function() {
        // Reabilitar botão
        if (botaoSalvar) {
            botaoSalvar.disabled = false;
            botaoSalvar.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Todas as Presenças';
        }
    });
}

// Função para mostrar toast notifications
function mostrarToast(mensagem, tipo) {
    tipo = tipo || 'info';
    // Remover toast anterior se existir
    var toastExistente = document.querySelector('.toast-notification');
    if (toastExistente) {
        toastExistente.remove();
    }
    
    // Criar elemento do toast
    var toast = document.createElement('div');
    toast.className = 'toast-notification alert alert-' + (tipo === 'success' ? 'success' : tipo === 'error' ? 'danger' : tipo === 'warning' ? 'warning' : 'info') + ' alert-dismissible fade show';
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    
    toast.innerHTML = '<strong>' + (tipo === 'success' ? 'Sucesso!' : tipo === 'error' ? 'Erro!' : tipo === 'warning' ? 'Atenção!' : 'Info!') + '</strong> ' + mensagem + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    
    // Adicionar ao body
    document.body.appendChild(toast);
    
    // Remover automaticamente após 5 segundos
    setTimeout(function() {
        if (toast && toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// Inicializar estatísticas
document.addEventListener('DOMContentLoaded', function() {
    atualizarEstatisticas();
    
    // Definir data atual como padrão se não estiver definida
    var dataInput = document.getElementById('data');
    if (dataInput && !dataInput.value) {
        var hoje = new Date().toISOString().split('T')[0];
        dataInput.value = hoje;
    }
});
</script>
{% endblock %}
