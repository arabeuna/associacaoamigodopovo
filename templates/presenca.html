{% extends "base.html" %}

{% block title %}Presença - Associação Amigo do Povo{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 text-center mb-4">
            <i class="fas fa-check-circle text-success"></i>
            Marcar Presença
        </h1>
    </div>
</div>

<!-- Formulário de Presença -->
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user-check me-2"></i>
                    Registrar Presença do Aluno
                </h5>
            </div>
            <div class="card-body">
                <form id="formPresenca">
                    <div class="mb-4">
                        <label for="nome_aluno" class="form-label">
                            <i class="fas fa-user me-2"></i>
                            Selecione o Aluno
                        </label>
                        <select class="form-select form-select-lg" id="nome_aluno" name="nome_aluno" required>
                            <option value="">-- Escolha um aluno --</option>
                            {% for aluno in alunos %}
                                <option value="{{ aluno.nome }}" data-turma="{{ aluno.turma }}" data-atividade="{{ aluno.atividade }}">{{ aluno.nome }} - {{ aluno.atividade }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-check me-2"></i>
                            Marcar Presença
                        </button>
                    </div>
                </form>
                
                <!-- Área de Feedback -->
                <div id="feedback" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para inserção manual de horário/turma -->
<div class="modal fade" id="modalPresencaDetalhada" tabindex="-1" aria-labelledby="modalPresencaDetalhadaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalPresencaDetalhadaLabel">
                    <i class="fas fa-clock me-2"></i>
                    Definir Horário e Turma
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formPresencaDetalhada">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-user me-2"></i>
                            Aluno Selecionado
                        </label>
                        <p id="alunoSelecionado" class="text-primary fs-6 mb-0"></p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dataPresenca" class="form-label">
                                    <i class="fas fa-calendar me-2"></i>
                                    Data
                                </label>
                                <input type="date" class="form-control" id="dataPresenca" name="dataPresenca" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="horarioPresenca" class="form-label">
                                    <i class="fas fa-clock me-2"></i>
                                    Horário
                                </label>
                                <input type="time" class="form-control" id="horarioPresenca" name="horarioPresenca" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="turmaPresenca" class="form-label">
                            <i class="fas fa-users me-2"></i>
                            Turma/Horário da Atividade
                        </label>
                        <input type="text" class="form-control" id="turmaPresenca" name="turmaPresenca" 
                               placeholder="Ex: Manhã, Tarde, 09:00, Básico, Avançado..." required>
                        <div class="form-text">Informe a turma ou horário específico da atividade</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoesPresenca" class="form-label">
                            <i class="fas fa-comment me-2"></i>
                            Observações (opcional)
                        </label>
                        <textarea class="form-control" id="observacoesPresenca" name="observacoesPresenca" rows="2" 
                                  placeholder="Informações adicionais sobre esta presença..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarPresenca">
                    <i class="fas fa-check me-2"></i>
                    Confirmar Presença
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Presença Rápida com Botões -->
<div class="row mt-5">
    <div class="col-12">
        <h4 class="text-center mb-4">
            <i class="fas fa-bolt text-warning me-2"></i>
            Presença Rápida
        </h4>
    </div>
</div>

<div class="row">
    {% for aluno in alunos %}
    <div class="col-md-4 col-lg-3 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                     style="width: 60px; height: 60px; font-size: 1.2rem;">
                    {{ aluno.nome.split()[0][0] }}{{ aluno.nome.split()[-1][0] if aluno.nome.split()|length > 1 else '' }}
                </div>
                <h6 class="card-title mb-2">{{ aluno.nome }}</h6>
                <p class="card-text text-muted small mb-3">{{ aluno.telefone }}</p>
                <div class="btn-group" role="group" aria-label="Ações de presença">
                    <button class="btn btn-outline-success btn-sm btn-presenca-rapida" 
                            data-nome="{{ aluno.nome }}" 
                            data-turma="{{ aluno.turma }}" 
                            data-atividade="{{ aluno.atividade }}">
                        <i class="fas fa-check me-1"></i>
                        Rápido
                    </button>
                    <button class="btn btn-outline-primary btn-sm btn-presenca-detalhada" 
                            data-nome="{{ aluno.nome }}" 
                            data-turma="{{ aluno.turma }}" 
                            data-atividade="{{ aluno.atividade }}">
                        <i class="fas fa-cog me-1"></i>
                        Manual
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Informações Adicionais -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Como Funciona
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-arrow-right text-primary me-2"></i>
                        Selecione o aluno na lista suspensa ou use os botões rápidos
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-arrow-right text-primary me-2"></i>
                        A presença será registrada com data e hora atual
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-arrow-right text-primary me-2"></i>
                        Visualize no dashboard as presenças do dia
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Horário Atual
                </h6>
            </div>
            <div class="card-body text-center">
                <h3 id="horario-atual" class="text-primary mb-0"></h3>
                <p class="text-muted mb-0" id="data-atual"></p>
            </div>
        </div>
    </div>
</div>

<!-- Botões de Navegação -->
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary me-2">
            <i class="fas fa-chart-line me-2"></i>
            Ver Dashboard
        </a>
        <a href="{{ url_for('alunos') }}" class="btn btn-outline-secondary">
            <i class="fas fa-users me-2"></i>
            Ver Alunos
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Atualizar horário em tempo real
    function atualizarHorario() {
        const agora = new Date();
        const horario = agora.toLocaleTimeString('pt-BR');
        const data = agora.toLocaleDateString('pt-BR');
        
        $('#horario-atual').text(horario);
        $('#data-atual').text(data);
    }
    
    // Atualizar a cada segundo
    atualizarHorario();
    setInterval(atualizarHorario, 1000);
    
    // Função para marcar presença
    function marcarPresenca(nomeAluno) {
        $.ajax({
            url: '/marcar_presenca',
            method: 'POST',
            data: {
                nome_aluno: nomeAluno
            },
            success: function(response) {
                if (response.success) {
                    $('#feedback').html(
                        '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                        '<i class="fas fa-check-circle me-2"></i>' +
                        response.message +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>'
                    );
                    
                    // Limpar seleção
                    $('#nome_aluno').val('');
                    
                    // Auto-dismiss após 3 segundos
                    setTimeout(function() {
                        $('.alert').alert('close');
                    }, 3000);
                } else {
                    $('#feedback').html(
                        '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                        '<i class="fas fa-exclamation-triangle me-2"></i>' +
                        response.message +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>'
                    );
                }
            },
            error: function() {
                $('#feedback').html(
                    '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                    '<i class="fas fa-times-circle me-2"></i>' +
                    'Erro ao conectar com o servidor. Tente novamente.' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                    '</div>'
                );
            }
        });
    }
    
    // Função para marcar presença com detalhes customizados
    function marcarPresencaDetalhada(nomeAluno, data, horario, turma, observacoes) {
        $.ajax({
            url: '/marcar_presenca_detalhada',
            method: 'POST',
            data: {
                nome_aluno: nomeAluno,
                data_presenca: data,
                horario_presenca: horario,
                turma_presenca: turma,
                observacoes_presenca: observacoes
            },
            success: function(response) {
                if (response.success) {
                    $('#feedback').html(
                        '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                        '<i class="fas fa-check-circle me-2"></i>' +
                        response.message +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>'
                    );
                    
                    // Fechar modal
                    $('#modalPresencaDetalhada').modal('hide');
                    
                    // Auto-dismiss após 3 segundos
                    setTimeout(function() {
                        $('.alert').alert('close');
                    }, 3000);
                } else {
                    $('#feedback').html(
                        '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                        '<i class="fas fa-exclamation-triangle me-2"></i>' +
                        response.message +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>'
                    );
                }
            },
            error: function() {
                $('#feedback').html(
                    '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                    '<i class="fas fa-times-circle me-2"></i>' +
                    'Erro ao conectar com o servidor. Tente novamente.' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                    '</div>'
                );
            }
        });
    }

    // Formulário principal - agora abre o modal
    $('#formPresenca').on('submit', function(e) {
        e.preventDefault();
        const nomeAluno = $('#nome_aluno').val();
        const alunoOption = $('#nome_aluno option:selected');
        
        if (nomeAluno) {
            // Preencher dados do modal
            $('#alunoSelecionado').text(nomeAluno + ' - ' + alunoOption.data('atividade'));
            
            // Preencher data e hora atual
            const agora = new Date();
            const dataAtual = agora.toISOString().split('T')[0];
            const horaAtual = agora.toTimeString().split(' ')[0].substring(0, 5);
            
            $('#dataPresenca').val(dataAtual);
            $('#horarioPresenca').val(horaAtual);
            $('#turmaPresenca').val(alunoOption.data('turma') || '');
            $('#observacoesPresenca').val('');
            
            // Abrir modal
            $('#modalPresencaDetalhada').modal('show');
        } else {
            $('#feedback').html(
                '<div class="alert alert-warning alert-dismissible fade show" role="alert">' +
                '<i class="fas fa-exclamation-triangle me-2"></i>' +
                'Por favor, selecione um aluno.' +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>'
            );
        }
    });
    
    // Botões de presença rápida
    $('.btn-presenca-rapida').on('click', function() {
        const nomeAluno = $(this).data('nome');
        const btn = $(this);
        
        // Feedback visual
        btn.removeClass('btn-outline-success').addClass('btn-success');
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Registrando...');
        btn.prop('disabled', true);
        
        marcarPresenca(nomeAluno);
        
        // Restaurar botão após 2 segundos
        setTimeout(function() {
            btn.removeClass('btn-success').addClass('btn-outline-success');
            btn.html('<i class="fas fa-check me-1"></i>Rápido');
            btn.prop('disabled', false);
        }, 2000);
    });
    
    // Botões de presença detalhada (manual)
    $('.btn-presenca-detalhada').on('click', function() {
        const nomeAluno = $(this).data('nome');
        const turmaAluno = $(this).data('turma');
        const atividadeAluno = $(this).data('atividade');
        
        // Preencher dados do modal
        $('#alunoSelecionado').text(nomeAluno + ' - ' + atividadeAluno);
        
        // Preencher data e hora atual
        const agora = new Date();
        const dataAtual = agora.toISOString().split('T')[0];
        const horaAtual = agora.toTimeString().split(' ')[0].substring(0, 5);
        
        $('#dataPresenca').val(dataAtual);
        $('#horarioPresenca').val(horaAtual);
        $('#turmaPresenca').val(turmaAluno || '');
        $('#observacoesPresenca').val('');
        
        // Abrir modal
        $('#modalPresencaDetalhada').modal('show');
    });
    
    // Confirmar presença detalhada
    $('#btnConfirmarPresenca').on('click', function() {
        const nomeAluno = $('#alunoSelecionado').text().split(' - ')[0];
        const data = $('#dataPresenca').val();
        const horario = $('#horarioPresenca').val();
        const turma = $('#turmaPresenca').val();
        const observacoes = $('#observacoesPresenca').val();
        
        if (!data || !horario || !turma) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
        }
        
        // Feedback visual no botão
        const btn = $(this);
        const textoOriginal = btn.html();
        btn.html('<i class="fas fa-spinner fa-spin me-2"></i>Registrando...');
        btn.prop('disabled', true);
        
        marcarPresencaDetalhada(nomeAluno, data, horario, turma, observacoes);
        
        // Restaurar botão após um tempo
        setTimeout(function() {
            btn.html(textoOriginal);
            btn.prop('disabled', false);
        }, 2000);
    });
    
    // Limpar modal quando fechado
    $('#modalPresencaDetalhada').on('hidden.bs.modal', function() {
        $('#formPresencaDetalhada')[0].reset();
        $('#alunoSelecionado').text('');
    });
});
</script>
{% endblock %}
